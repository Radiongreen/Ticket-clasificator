<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Gastos IA</title>
    
    <!-- Meta tags para PWA -->
    <meta name="theme-color" content="#4f46e5"/>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/4f46e5/ffffff?text=GASTO">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-button { padding: 0.75rem 1rem; border-bottom: 3px solid transparent; transition: all 0.3s ease; cursor: pointer; white-space: nowrap; }
        .tab-button.active { border-color: #4f46e5; color: #4f46e5; background-color: #eef2ff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .loader { border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid #4f46e5; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { transition: opacity 0.3s ease; }
        #app-container.hidden, #landing-page.hidden { display: none; }
        .table-actions button:disabled { background-color: #d1d5db; cursor: not-allowed; }
        .achievement.unlocked { opacity: 1; }
        .achievement.locked { opacity: 0.4; filter: grayscale(100%); }
        .premium-feature { position: relative; border: 2px dashed #d1d5db; padding: 2rem; border-radius: 0.5rem; margin-top: 1rem; }
        .premium-overlay { position: absolute; inset: 0; background-color: rgba(249, 250, 251, 0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; border-radius: 0.5rem; cursor: pointer; }
        #ads-banner.hidden { display: none; }
        #user-menu { transition: opacity 0.3s, transform 0.3s; }
        .nav-container { overflow-x: auto; -ms-overflow-style: none; scrollbar-width: none; }
        .nav-container::-webkit-scrollbar { display: none; }
        .confirm-input {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            width: 100%;
        }
        .confirm-input:read-only {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }
        .confirm-select {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            width: 100%;
            background-color: white;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- LANDING PAGE (Visible para usuarios no logueados) -->
    <div id="landing-page">
        <header class="container mx-auto p-6 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-indigo-600">Gestor de Gastos IA</h1>
            <button id="landing-login-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">Iniciar Sesión</button>
        </header>

        <main>
            <section class="text-center py-20 px-6 bg-white">
                <h2 class="text-4xl md:text-5xl font-extrabold text-gray-900 leading-tight">La forma más inteligente de controlar tus gastos de supermercado.</h2>
                <p class="mt-4 text-lg md:text-xl text-gray-600 max-w-3xl mx-auto">Convierte tus tickets en datos, descubre tus hábitos de consumo y deja que nuestro Chef Inteligente te diga qué cocinar para no desperdiciar comida.</p>
                <button id="landing-register-btn" class="mt-8 bg-indigo-600 text-white font-bold py-4 px-8 rounded-lg text-lg hover:bg-indigo-700 transition-colors">Regístrate Gratis con Google</button>
            </section>

            <section class="py-20">
                <div class="container mx-auto px-6 text-center">
                    <h3 class="text-3xl font-bold mb-16">Todo lo que necesitas para ahorrar de verdad</h3>
                    <div class="grid md:grid-cols-3 gap-12">
                        <div class="bg-white p-8 rounded-lg shadow-md">
                            <i class="fas fa-camera fa-3x text-indigo-500"></i>
                            <h4 class="text-xl font-bold mt-4 mb-2">Escanea y Olvídate</h4>
                            <p class="text-gray-600">Saca una foto a tu ticket y nuestra IA extraerá cada producto, precio y categoría por ti. Di adiós a la entrada manual de datos.</p>
                        </div>
                        <div class="bg-white p-8 rounded-lg shadow-md">
                            <i class="fas fa-chart-pie fa-3x text-indigo-500"></i>
                            <h4 class="text-xl font-bold mt-4 mb-2">Entiende tus Gastos</h4>
                            <p class="text-gray-600">Con gráficos interactivos y una categorización detallada, sabrás exactamente a dónde va tu dinero. Toma el control de tus finanzas.</p>
                        </div>
                        <div class="bg-white p-8 rounded-lg shadow-md">
                            <i class="fas fa-utensils fa-3x text-indigo-500"></i>
                            <h4 class="text-xl font-bold mt-4 mb-2">Cocina con lo que Tienes</h4>
                            <p class="text-gray-600">Nuestro Chef Inteligente analiza tu despensa virtual y te sugiere recetas deliciosas para que no desperdicies comida.</p>
                        </div>
                    </div>
                </div>
            </section>

            <section class="py-20 bg-white text-center">
                <h3 class="text-3xl font-bold">¿Listo para empezar a ahorrar?</h3>
                <button id="final-cta-btn" class="mt-8 bg-indigo-600 text-white font-bold py-4 px-8 rounded-lg text-lg hover:bg-indigo-700 transition-colors">Crea tu Cuenta Gratis</button>
            </section>
        </main>
    </div>


    <!-- CONTENEDOR PRINCIPAL DE LA APP (Oculto inicialmente) -->
    <div id="app-container" class="hidden">
        <div class="container mx-auto p-4 md:p-8">
            <header class="mb-8 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Gestor de Gastos IA</h1>
                    <p class="text-gray-600 mt-1">Tu asistente de ahorro inteligente.</p>
                </div>
                <div id="auth-container" class="relative"></div>
            </header>
            
            <div id="app-content">
                <!-- Navegación por pestañas -->
                <div class="mb-8 border-b border-gray-200">
                    <div class="nav-container">
                        <nav class="flex -mb-px" aria-label="Tabs">
                            <button class="tab-button active" data-tab="analizar-ticket"><i class="fas fa-receipt mr-2"></i>Analizar Ticket</button>
                            <button class="tab-button" data-tab="mis-gastos"><i class="fas fa-chart-pie mr-2"></i>Mis Gastos</button>
                            <button class="tab-button" data-tab="mis-productos"><i class="fas fa-tag mr-2"></i>Mis Productos</button>
                            <button class="tab-button" data-tab="lista-compra"><i class="fas fa-list-check mr-2"></i>Lista de Compra</button>
                            <button class="tab-button" data-tab="chef-inteligente"><i class="fas fa-utensils mr-2"></i>Chef Inteligente</button>
                            <button class="tab-button" data-tab="mi-hogar"><i class="fas fa-users mr-2"></i>Mi Hogar</button>
                            <button class="tab-button" data-tab="logros"><i class="fas fa-trophy mr-2"></i>Mis Logros</button>
                            <button class="tab-button" data-tab="premium"><i class="fas fa-star mr-2"></i>Premium</button>
                        </nav>
                    </div>
                </div>

                <!-- Contenido de las pestañas -->
                <main>
                    <!-- Pestaña: Analizar Ticket -->
                    <div id="analizar-ticket" class="tab-content active">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                <h2 class="text-xl font-semibold mb-4">1. Sube tu Ticket</h2>
                                <div id="image-uploader" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                                    <div class="space-y-1 text-center">
                                        <i class="fas fa-camera fa-3x text-gray-400"></i>
                                        <div class="flex text-sm text-gray-600">
                                            <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                                                <span>Sube un archivo</span>
                                                <input id="file-upload" name="file-upload" type="file" class="sr-only" accept="image/*">
                                            </label>
                                            <p class="pl-1">o arrástralo aquí</p>
                                        </div>
                                        <p class="text-xs text-gray-500">PNG, JPG, GIF hasta 10MB</p>
                                    </div>
                                </div>
                                <button id="process-ticket-btn" class="mt-6 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 disabled:bg-gray-400" disabled>
                                    <i class="fas fa-cogs mr-2"></i> Procesar Ticket
                                </button>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                <h2 class="text-xl font-semibold mb-4">2. Vista Previa</h2>
                                <div id="image-preview-container" class="w-full h-64 bg-gray-100 rounded-lg flex items-center justify-center text-gray-500">
                                    <p>Aquí verás la imagen de tu ticket.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pestaña: Mis Gastos -->
                    <div id="mis-gastos" class="tab-content">
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-8">
                            <h2 class="text-xl font-semibold mb-4">Filtros de Visualización</h2>
                            <div class="flex flex-wrap gap-4">
                                <select id="context-filter" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full md:w-auto p-2.5"></select>
                                <select id="filter-year" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full md:w-auto p-2.5"></select>
                                <select id="filter-month" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full md:w-auto p-2.5"></select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 flex flex-col justify-center items-center">
                                <h3 class="text-lg font-semibold mb-2">Gasto Total</h3>
                                <p id="total-expense" class="text-3xl font-bold text-indigo-600">0,00 €</p>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 flex flex-col justify-center items-center">
                                <h3 class="text-lg font-semibold mb-2">Nº de Compras</h3>
                                <p id="total-purchases" class="text-3xl font-bold text-indigo-600">0</p>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 flex flex-col justify-center items-center">
                                <h3 class="text-lg font-semibold mb-2">vs. Mes Anterior</h3>
                                <div id="monthly-comparison" class="text-3xl font-bold text-gray-500">--</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                <h3 class="text-lg font-semibold mb-4 text-center">Gasto por Supermercado</h3>
                                <div class="h-64 md:h-80"><canvas id="supermarket-chart"></canvas></div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 id="category-chart-title" class="text-lg font-semibold">Gasto por Categoría Principal</h3>
                                    <button id="category-chart-back-btn" class="hidden text-sm text-indigo-600 hover:underline"><i class="fas fa-arrow-left mr-1"></i> Volver</button>
                                </div>
                                <div class="h-64 md:h-80"><canvas id="category-chart"></canvas></div>
                            </div>
                        </div>
                         <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold" id="history-title">Historial de Compras</h3>
                                <div class="table-actions flex items-center gap-4">
                                    <button id="reset-filter-btn" class="hidden bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                                        <i class="fas fa-times mr-2"></i>Quitar Filtro
                                    </button>
                                    <button id="delete-selected-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300" disabled>
                                        <i class="fas fa-trash mr-2"></i>Eliminar seleccionados
                                    </button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="p-4">
                                                <input type="checkbox" id="select-all-checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                                            </th>
                                            <th scope="col" class="px-6 py-3">Fecha</th>
                                            <th scope="col" class="px-6 py-3">Supermercado</th>
                                            <th scope="col" class="px-6 py-3">Total</th>
                                            <th scope="col" class="px-6 py-3">Asignado a</th>
                                        </tr>
                                    </thead>
                                    <tbody id="purchases-history"></tbody>
                                </table>
                            </div>
                        </div>
                        <div id="ads-banner" class="hidden mt-8 p-4 bg-gray-200 rounded-lg text-center text-gray-600">
                            <p class="text-sm">Espacio para publicidad (Visible solo para usuarios gratuitos)</p>
                        </div>
                    </div>

                    <!-- Pestaña: Mis Productos -->
                    <div id="mis-productos" class="tab-content">
                         <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h2 class="text-xl font-semibold mb-4">Gestión de Productos</h2>
                            <p class="text-sm text-gray-600 mb-4">Aquí puedes ver todos los productos únicos que has comprado y corregir su categorización si es necesario. Los cambios se aplicarán a todas las compras pasadas.</p>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">Producto</th>
                                            <th scope="col" class="px-6 py-3">Categoría Principal</th>
                                            <th scope="col" class="px-6 py-3">Familia</th>
                                            <th scope="col" class="px-6 py-3">Subfamilia</th>
                                            <th scope="col" class="px-6 py-3">Nº Compras</th>
                                            <th scope="col" class="px-6 py-3">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="products-table"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pestaña: Lista de la Compra -->
                    <div id="lista-compra" class="tab-content">
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h2 class="text-xl font-semibold mb-4">Lista de la Compra Inteligente</h2>
                            <div class="flex gap-2 mb-4">
                                <input type="text" id="add-item-input" placeholder="Añadir producto..." class="flex-grow bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5">
                                <button id="add-item-btn" class="bg-indigo-600 text-white px-4 rounded-lg"><i class="fas fa-plus"></i></button>
                            </div>
                            <div id="shopping-list" class="space-y-2 mb-6">
                            </div>
                            <div class="border-t pt-4">
                                 <h3 class="font-semibold mb-2">Sugerencias Predictivas</h3>
                                 <p class="text-sm text-gray-600 mb-4">Basado en tus hábitos de consumo, puede que necesites reponer esto:</p>
                                 <button id="suggest-items-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                                    <i class="fas fa-wand-magic-sparkles mr-2"></i>Generar Sugerencias
                                 </button>
                                 <div id="suggestions-container" class="mt-4 space-y-2"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Pestaña: Chef Inteligente -->
                    <div id="chef-inteligente" class="tab-content">
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h2 class="text-xl font-semibold mb-4">Chef Inteligente 🧑‍🍳</h2>
                            <p class="text-sm text-gray-600 mb-4">¿No sabes qué cocinar? Dime qué tipo de comida te apetece y te daré ideas basadas en los ingredientes que probablemente tienes en tu despensa.</p>
                            <div class="flex gap-2 mb-4">
                                <input type="text" id="chef-query-input" placeholder="Ej: ¿Qué puedo hacer para cenar rápido?" class="flex-grow bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5">
                                <button id="chef-ask-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                                    Preguntar
                                 </button>
                            </div>
                            <div id="chef-suggestions-container" class="mt-6 p-4 bg-gray-50 rounded-lg min-h-[100px]">
                            </div>
                        </div>
                    </div>

                    <!-- Pestaña: Mi Hogar -->
                    <div id="mi-hogar" class="tab-content">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                <h2 class="text-xl font-semibold mb-4">Gestionar Mi Hogar</h2>
                                <div id="household-management">
                                    <!-- Contenido dinámico: crear, unirse o ver miembros -->
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                <h2 class="text-xl font-semibold mb-4">Miembros del Hogar</h2>
                                <ul id="household-members-list" class="space-y-3">
                                    <!-- Lista de miembros -->
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Pestaña: Mis Logros -->
                    <div id="logros" class="tab-content">
                         <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h2 class="text-xl font-semibold mb-4">Mis Logros</h2>
                            <div id="achievements-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 text-center mb-8">
                                <!-- Los logros se generarán aquí -->
                            </div>
                            <h2 class="text-xl font-semibold mb-4 border-t pt-6">Reto Semanal</h2>
                            <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                                <div class="flex items-center">
                                    <i class="fas fa-bullseye fa-2x text-blue-500 mr-4"></i>
                                    <div>
                                        <h3 class="font-bold">Gasta un 10% menos en "Snacks"</h3>
                                        <p class="text-sm text-gray-600">¡Acepta el reto y mejora tus hábitos de ahorro!</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pestaña: Premium -->
                    <div id="premium" class="tab-content">
                         <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h2 class="text-xl font-semibold mb-4">Funciones Premium</h2>
                            
                            <div class="premium-feature">
                                <h3 class="text-lg font-semibold mb-2">Módulo Avanzado de Análisis de Precios</h3>
                                <p class="text-gray-600">Gráficos de evolución, comparador de supermercados y alertas de ofertas.</p>
                                <div class="premium-overlay">
                                    <i class="fas fa-lock fa-2x text-yellow-500 mb-2"></i>
                                    <p class="font-semibold">Función Premium</p>
                                    <button class="mt-4 bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg upgrade-btn">¡Actualiza ahora!</button>
                                </div>
                            </div>

                            <div class="premium-feature">
                                <h3 class="text-lg font-semibold mb-2">Módulo de Presupuestos Inteligentes</h3>
                                <p class="text-gray-600">Define límites por categoría, recibe alertas en tiempo real y obtén recomendaciones de ahorro.</p>
                                 <div class="premium-overlay">
                                    <i class="fas fa-lock fa-2x text-yellow-500 mb-2"></i>
                                    <p class="font-semibold">Función Premium</p>
                                    <button class="mt-4 bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg upgrade-btn">¡Actualiza ahora!</button>
                                </div>
                            </div>
                         </div>
                    </div>

                </main>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="processing-overlay" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center">
            <div class="loader mx-auto"></div>
            <p id="processing-text" class="mt-4 text-lg font-medium">Procesando ticket...</p>
        </div>
    </div>
    <div id="message-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full mx-auto">
            <h3 id="modal-title" class="text-lg font-bold"></h3>
            <p id="modal-message" class="mt-2 text-sm text-gray-600"></p>
            <div class="mt-4 text-right">
                <button id="modal-close-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Cerrar</button>
            </div>
        </div>
    </div>
    <div id="confirmation-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-auto max-h-[90vh] flex flex-col">
            <div class="p-6 border-b">
                <h3 class="text-xl font-bold text-gray-900">Confirmar y Editar Datos del Ticket</h3>
                <p class="text-sm text-gray-600">Revisa y corrige los datos extraídos por la IA antes de guardar.</p>
            </div>
            <div id="confirmation-content" class="p-6 overflow-y-auto"></div>
            <div class="p-4 bg-gray-50 border-t flex justify-between items-center">
                <div class="font-bold text-lg">Total: <span id="confirmation-total">0.00</span>€</div>
                <div class="flex gap-4">
                    <button id="confirm-cancel-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button id="confirm-continue-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Continuar a Asignación</button>
                </div>
            </div>
        </div>
    </div>
    <div id="assign-expense-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-auto max-h-[90vh] flex flex-col">
            <div class="p-6 border-b">
                <h3 class="text-xl font-bold text-gray-900">Asignar Gastos del Ticket</h3>
                <p class="text-sm text-gray-600">Decide si cada producto es un gasto personal o del hogar.</p>
            </div>
            <div id="assign-expense-content" class="p-6 overflow-y-auto"></div>
            <div class="p-4 bg-gray-50 border-t flex justify-end gap-4">
                <button id="assign-save-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Guardar Compra</button>
            </div>
        </div>
    </div>
    <div id="delete-confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full mx-auto">
            <h3 id="delete-modal-title" class="text-lg font-bold">Confirmar eliminación</h3>
            <p id="delete-modal-message" class="mt-2 text-sm text-gray-600"></p>
            <div class="mt-4 flex justify-end gap-4">
                <button id="delete-cancel-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button id="delete-confirm-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Eliminar</button>
            </div>
        </div>
    </div>
    <div id="welcome-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-auto text-center">
            <i class="fas fa-rocket fa-3x text-indigo-500 mb-4"></i>
            <h3 class="text-2xl font-bold">¡Bienvenido a tu Gestor de Gastos!</h3>
            <p class="mt-4 text-gray-600">Para empezar, ve a la pestaña <strong>"Analizar Ticket"</strong>, sube una foto de tu primer recibo, y deja que la magia de la IA haga el resto.</p>
            <div class="mt-6">
                <button id="welcome-close-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">¡Entendido!</button>
            </div>
        </div>
    </div>
    <div id="upgrade-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-auto">
            <div class="text-center">
                <i class="fas fa-star fa-3x text-yellow-500 mb-4"></i>
                <h3 class="text-2xl font-bold">Desbloquea todo el Potencial</h3>
            </div>
            <ul class="mt-4 space-y-2 text-gray-600">
                <li class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i> <strong>Análisis de Precios:</strong> Compara supermercados y sigue la evolución de los precios.</li>
                <li class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i> <strong>Presupuestos Inteligentes:</strong> Fija límites por categoría y recibe alertas.</li>
                <li class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i> <strong>Exportación de Datos:</strong> Descarga tus gastos en CSV o PDF.</li>
                <li class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i> <strong>Sin Anuncios:</strong> Disfruta de una experiencia limpia y sin interrupciones.</li>
            </ul>
            <div class="mt-6">
                <button class="w-full bg-yellow-500 text-white font-bold py-3 rounded-lg hover:bg-yellow-600">Suscribirse a Premium (Próximamente)</button>
                <button id="upgrade-close-btn" class="w-full mt-2 text-sm text-gray-500 hover:underline">Quizás más tarde</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Edición de Producto -->
    <div id="edit-product-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-auto max-h-[90vh] flex flex-col">
            <div class="p-6 border-b">
                <h3 class="text-xl font-bold text-gray-900">Editar Producto</h3>
                <p class="text-sm text-gray-600">Corrige los detalles del producto y la categorización.</p>
            </div>
            <div class="p-6 overflow-y-auto space-y-4">
                <input type="hidden" id="edit-product-id">
                <input type="hidden" id="edit-product-original-name">
                <div>
                    <label for="edit-product-name" class="block text-sm font-medium text-gray-700">Nombre del Producto</label>
                    <input type="text" id="edit-product-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="edit-category-principal" class="block text-sm font-medium text-gray-700">Categoría Principal</label>
                    <select id="edit-category-principal" class="mt-1 block w-full bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                </div>
                <div>
                    <label for="edit-category-familia" class="block text-sm font-medium text-gray-700">Familia</label>
                    <select id="edit-category-familia" class="mt-1 block w-full bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                </div>
                <div>
                    <label for="edit-category-subfamilia" class="block text-sm font-medium text-gray-700">Subfamilia</label>
                    <select id="edit-category-subfamilia" class="mt-1 block w-full bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end gap-4">
                <button id="edit-product-cancel-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button id="edit-product-save-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Guardar Cambios</button>
            </div>
        </div>
    </div>

    
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, writeBatch, deleteDoc, setDoc, getDoc, updateDoc, query, where, getDocs, serverTimestamp, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONFIGURACIÓN E INICIALIZACIÓN ---
        const firebaseConfig = {
          apiKey: "AIzaSyChOxUkl2C_4g7duYdFE0oUlQ9vpjLTJYQ", // <-- Clave de API principal de Firebase ("Browser key")
          authDomain: "tickets-clasificator.firebaseapp.com",
          projectId: "tickets-clasificator",
          storageBucket: "tickets-clasificator.firebasestorage.app",
          messagingSenderId: "929759305226",
          appId: "1:929759305226:web:792b430618ae4a419a09f3",
          measurementId: "G-FW5ER1GV03"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        
        // --- ESTADO GLOBAL DE LA APLICACIÓN ---
        let currentUser = null;
        let userProfile = null;
        let allPurchases = [];
        let allUserProducts = [];
        let currentFilteredPurchases = [];
        let selectedPurchases = new Set();
        let supermarketChart = null;
        let categoryChart = null;
        let currentTicketData = null; 
        let currentFile = null;
        let categoryChartLevel = 1; 
        let selectedPrincipal = null;
        let selectedFamilia = null;
        let chartFilter = { type: null, value: null };
        let unsubscribePurchases = () => {};
        let unsubscribeProducts = () => {};
        let unsubscribeProfile = () => {};

        // --- DEFINICIÓN DE CATEGORÍAS ---
        const categorias = {
            "🛒 ALIMENTOS Y BEBIDAS": {
                "🍓🥦 Frutas y Verduras": ["🥬 Verduras", "🥔 Tubérculos", "🍄 Setas y Hongos", "🍎 Frutas Frescas", "🍇 Frutas Deshidratadas"],
                "🥩🍗 Carnes y Aves": ["🐔 Aves", "🐄 Ternera", "🐖 Cerdo", "🐑 Cordero", "🌭 Embutidos"],
                "🐟🦐 Pescados y Mariscos": ["🐠 Pescado Fresco", "🦞 Marisco Fresco", "🧊 Pescado Congelado", "🥫 Conservas de Pescado"],
                "🥛🥚 Lácteos y Huevos": ["🥛 Leche", "🍮 Yogures y Postres Lácteos", "🧀 Quesos", "🥚 Huevos"],
                "🍞🥐 Panadería y Pastelería": ["🥖 Pan", "🍩 Bollería", "🍰 Pasteles", "🍪 Galletas"],
                "🌾🫘 Cereales y Legumbres": ["🍚 Arroz", "🍝 Pasta", "🥣 Legumbres Secas", "🥣 Cereales de Desayuno"],
                "🍾🍶 Aceites, Vinagres y Salsas": ["🫒 Aceites Comestibles", "🍇 Vinagres", "🥫 Salsas Preparadas", "🧂 Condimentos y Especias"],
                "🥫🥡 Conservas y Platos Preparados": ["🫙 Conservas Vegetales", "🥩 Conservas Cárnicas", "🍲 Platos Listos para Consumir"],
                "🧊 Congelados": ["🥦 Verduras Congeladas", "🐟 Pescado Congelado", "🍕 Comidas Preparadas Congeladas", "🍨 Helados"],
                "🥤 Bebidas": ["🧃 Bebidas No Alcohólicas", "🍺 Bebidas Alcohólicas"],
                "🥨🍬 Snacks y Dulces": ["🍟 Patatas Fritas y Aperitivos", "🍫 Chocolates y Golosinas", "🥜 Frutos Secos"],
                "❤️‍🩹 Dietéticos y Especiales": ["🚫🌾 Sin Gluten", "🚫🥛 Sin Lactosa", "🌱 Orgánicos/Biológicos", "🌿 Vegetarianos/Veganos"]
            },
            "🏠 HOGAR Y LIMPIEZA": {
                "🧼🧽 Productos de Limpieza": ["🧴 Limpiadores Multiusos", "🧺 Detergentes para Ropa", "🚽 Productos de Baño y Cocina", "🦟 Insecticidas"],
                "🍴🍽️ Menaje y Utensilios": ["🍷 Vajilla y Cristalería", "🍳 Batería de Cocina", "🔌 Pequeños Electrodomésticos"],
                "🏡 Cuidado del Hogar": ["🧻 Papel de Cocina y Servilletas", "🗑️ Bolsas de Basura", "🔋💡 Pilas y Bombillas", "🌬️ Ambientadores"]
            },
            "🧴 HIGIENE Y CUIDADO PERSONAL": {
                "🚿🧼 Higiene Diaria": ["🧴 Champú y Acondicionador", "🧼 Gel de Ducha y Jabón", "🦷 Pasta de Dientes y Cuidado Bucal", "💨 Desodorantes"],
                "💆‍♀️💅 Cuidado Facial y Corporal": ["🧴 Cremas y Lociones", "💄 Maquillaje", "☀️ Protector Solar"],
                "⚕️💊 Farmacia/Parafarmacia": ["💊 Medicamentos Sin Receta", "💪 Suplementos y Vitaminas", "🩹 Material de Primeros Auxilios"]
            },
            "🐾 MASCOTAS": {
                "🦴🍖 Alimento para Mascotas": ["🐶 Perros", "🐱 Gatos", "🐹 Otras Mascotas"],
                "🧸 Accesorios para Mascotas": ["🎾 Juguetes", "🧼 Productos de Higiene para Mascotas"]
            },
            "💸 OTROS GASTOS": {
                "🛍️ Varios": ["🎁 Regalos", "📰 Prensa y Revistas", "❓ Sin especificar"]
            }
        };
        const chartColors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E57373', '#64B5F6', '#FFF176', '#4DB6AC', '#CE93D8', '#FFD54F'];

        // --- DOM ELEMENTS ---
        const landingPage = document.getElementById('landing-page');
        const appContainer = document.getElementById('app-container');
        const authContainer = document.getElementById('auth-container');
        const processingOverlay = document.getElementById('processing-overlay');
        const processingText = document.getElementById('processing-text');

        // --- MANEJO DE AUTENTICACIÓN Y VISIBILIDAD ---
        const handleLogin = () => {
            signInWithPopup(auth, provider).catch(handleAuthError);
        };

        const handleSignOut = () => {
            signOut(auth).catch((error) => console.error("Error al cerrar sesión:", error));
        };
        
        onAuthStateChanged(auth, async (user) => {
            // Limpiar listeners anteriores para evitar duplicados
            unsubscribePurchases();
            unsubscribeProducts();
            unsubscribeProfile();

            if (user) {
                currentUser = user;
                await setupUser(user);
                landingPage.classList.add('hidden');
                appContainer.classList.remove('hidden');
            } else {
                currentUser = null;
                userProfile = null;
                landingPage.classList.remove('hidden');
                appContainer.classList.add('hidden');
                resetAppState();
            }
        });
        
        async function setupUser(user) {
            const userRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userRef);

            if (!userDoc.exists()) {
                // Es un usuario nuevo
                await setDoc(userRef, {
                    displayName: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL,
                    createdAt: serverTimestamp(),
                    householdId: null,
                    plan: 'free'
                });
                showWelcomeModal();
            }
            
            // Escuchar cambios en el perfil del usuario (ej: si se une a un hogar)
            unsubscribeProfile = onSnapshot(userRef, (doc) => {
                userProfile = { id: doc.id, ...doc.data() };
                renderAuthContainer(user, userProfile);
                renderHouseholdTab(userProfile);
                updateContextFilter(userProfile);
                // Volver a cargar los datos si el householdId cambia
                loadInitialData(); 
                loadProducts();
            });
        }

        function loadInitialData() {
            if (!currentUser) return;
            
            unsubscribePurchases(); // Detener listener anterior

            const ticketsQuery = query(collection(db, "tickets"), where("userId", "==", currentUser.uid));

            // Usamos onSnapshot para escuchar cambios en tiempo real
            unsubscribePurchases = onSnapshot(ticketsQuery, (snapshot) => {
                allPurchases = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateFilters();
                renderDashboard();
            });
        }
        
        function loadProducts() {
            if (!currentUser) return;
            unsubscribeProducts();
            const productsQuery = query(collection(db, "products"), where("userId", "==", currentUser.uid));
            unsubscribeProducts = onSnapshot(productsQuery, (snapshot) => {
                allUserProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProductsTable();
            });
        }

        // --- LÓGICA DE LA INTERFAZ (Tabs, Modals, etc.) ---
        
        function setupEventListeners() {
            // Botones de login en landing page
            document.getElementById('landing-login-btn').addEventListener('click', handleLogin);
            document.getElementById('landing-register-btn').addEventListener('click', handleLogin);
            document.getElementById('final-cta-btn').addEventListener('click', handleLogin);

            // Navegación por pestañas
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.dataset.tab;
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    button.classList.add('active');
                    document.getElementById(tabName).classList.add('active');
                });
            });

            // Modals
            document.getElementById('modal-close-btn').addEventListener('click', () => hideModal('message-modal'));
            document.getElementById('welcome-close-btn').addEventListener('click', () => hideModal('welcome-modal'));
            document.getElementById('upgrade-close-btn').addEventListener('click', () => hideModal('upgrade-modal'));
            document.querySelectorAll('.upgrade-btn').forEach(btn => btn.addEventListener('click', () => showModal('upgrade-modal')));
            
            // Analizar Ticket
            const fileUpload = document.getElementById('file-upload');
            fileUpload.addEventListener('change', handleFileSelect);
            document.getElementById('image-uploader').addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); e.currentTarget.classList.add('bg-indigo-50'); });
            document.getElementById('image-uploader').addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); e.currentTarget.classList.remove('bg-indigo-50'); });
            document.getElementById('image-uploader').addEventListener('drop', handleFileDrop);
            document.getElementById('process-ticket-btn').addEventListener('click', processTicket);

            // Confirmación y guardado
            document.getElementById('confirm-cancel-btn').addEventListener('click', () => hideModal('confirmation-modal'));
            document.getElementById('confirm-continue-btn').addEventListener('click', () => {
                updateTicketDataFromModal();
                showAssignExpenseModal();
            });
            document.getElementById('assign-save-btn').addEventListener('click', saveTicketData);
            document.getElementById('confirmation-content').addEventListener('change', (e) => {
                if(e.target.classList.contains('confirm-price-input')) {
                    updateConfirmationTotal();
                }
                if(e.target.classList.contains('confirm-cat-principal')) {
                    const index = e.target.dataset.index;
                    populateFamiliaDropdown(null, `confirm-cat-familia-${index}`, e.target.value);
                }
                if(e.target.classList.contains('confirm-cat-familia')) {
                    const index = e.target.dataset.index;
                    const principalSelect = document.getElementById(`confirm-cat-principal-${index}`);
                    populateSubfamiliaDropdown(null, `confirm-cat-subfamilia-${index}`, principalSelect.value, e.target.value);
                }
            });
            document.getElementById('confirmation-content').addEventListener('click', (e) => {
                if (e.target.closest('.delete-product-row-btn')) {
                    const button = e.target.closest('.delete-product-row-btn');
                    const index = button.dataset.index;
                    const row = document.getElementById(`product-row-${index}`);
                    if (row) {
                        row.remove();
                        updateConfirmationTotal();
                    }
                }
            });


            // Mis Gastos
            document.getElementById('filter-year').addEventListener('change', renderDashboard);
            document.getElementById('filter-month').addEventListener('change', renderDashboard);
            document.getElementById('context-filter').addEventListener('change', renderDashboard);
            document.getElementById('select-all-checkbox').addEventListener('change', handleSelectAll);
            document.getElementById('delete-selected-btn').addEventListener('click', confirmDeleteSelected);
            document.getElementById('category-chart-back-btn').addEventListener('click', handleCategoryChartBack);
            document.getElementById('reset-filter-btn').addEventListener('click', resetChartFilter);
            
            // Mis Productos
            document.getElementById('products-table').addEventListener('click', (e) => {
                if (e.target.closest('.edit-product-btn')) {
                    const button = e.target.closest('.edit-product-btn');
                    openEditProductModal(button.dataset.id);
                }
            });
            document.getElementById('edit-product-cancel-btn').addEventListener('click', () => hideModal('edit-product-modal'));
            document.getElementById('edit-product-save-btn').addEventListener('click', saveProductChanges);
            document.getElementById('edit-category-principal').addEventListener('change', () => populateFamiliaDropdown(null, 'edit-category-familia', document.getElementById('edit-category-principal').value));
            document.getElementById('edit-category-familia').addEventListener('change', () => populateSubfamiliaDropdown(null, 'edit-category-subfamilia', document.getElementById('edit-category-principal').value, document.getElementById('edit-category-familia').value));
        }

        // --- RENDERIZADO DE COMPONENTES DE UI ---

        function renderAuthContainer(user, profile) {
            authContainer.innerHTML = `
                <div class="flex items-center gap-4 cursor-pointer" id="user-profile-button">
                    <img src="${user.photoURL}" alt="${user.displayName}" class="w-10 h-10 rounded-full">
                </div>
                <div id="user-menu" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-md shadow-lg py-1 z-50 origin-top-right">
                    <div class="px-4 py-3">
                        <p class="text-sm">Conectado como</p>
                        <p class="font-medium text-gray-900 truncate">${user.displayName}</p>
                    </div>
                    <div class="border-t border-gray-100 px-4 py-3">
                        <p class="text-sm font-medium text-gray-900">Tu ID de Usuario:</p>
                        <p class="text-xs text-gray-500 break-all" id="user-id-display">${user.uid}</p>
                        <button id="copy-user-id" class="text-indigo-600 text-xs mt-1 hover:underline">Copiar ID</button>
                    </div>
                    <div class="border-t border-gray-100">
                        <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Cerrar sesión</a>
                    </div>
                </div>
            `;
            document.getElementById('logout-btn').addEventListener('click', handleSignOut);
            document.getElementById('user-profile-button').addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('user-menu').classList.toggle('hidden');
            });
            document.getElementById('copy-user-id').addEventListener('click', () => {
                const textArea = document.createElement("textarea");
                textArea.value = user.uid;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showMessage("Copiado", "Tu ID de usuario ha sido copiado.");
            });
        }
        
        function renderHouseholdTab(profile) {
            const container = document.getElementById('household-management');
            const membersList = document.getElementById('household-members-list');
            membersList.innerHTML = ''; // Limpiar lista de miembros

            if (profile && profile.householdId) {
                // Usuario está en un hogar
                container.innerHTML = `
                    <p class="text-gray-600 mb-2">Perteneces al hogar con ID:</p>
                    <p class="font-mono bg-gray-100 p-2 rounded break-all mb-4">${profile.householdId}</p>
                    <button id="leave-household-btn" class="w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">Abandonar Hogar</button>
                `;
                document.getElementById('leave-household-btn').addEventListener('click', leaveHousehold);
                // Cargar y mostrar miembros
                loadHouseholdMembers(profile.householdId);
            } else {
                // Usuario no está en un hogar
                container.innerHTML = `
                    <div class="mb-6">
                        <h3 class="font-semibold mb-2">Crear un nuevo hogar</h3>
                        <p class="text-sm text-gray-600 mb-2">Crea un espacio compartido para gestionar los gastos familiares.</p>
                        <div class="flex gap-2">
                            <input type="text" id="household-name-input" placeholder="Nombre del hogar (Ej: Familia Pérez)" class="flex-grow bg-gray-50 border border-gray-300 rounded-lg p-2.5">
                            <button id="create-household-btn" class="bg-indigo-600 text-white px-4 rounded-lg hover:bg-indigo-700">Crear</button>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold mb-2">Unirse a un hogar existente</h3>
                        <p class="text-sm text-gray-600 mb-2">Si un familiar ya ha creado un hogar, introduce su ID aquí.</p>
                        <div class="flex gap-2">
                            <input type="text" id="join-household-id-input" placeholder="ID del hogar" class="flex-grow bg-gray-50 border border-gray-300 rounded-lg p-2.5">
                            <button id="join-household-btn" class="bg-green-500 text-white px-4 rounded-lg hover:bg-green-600">Unirse</button>
                        </div>
                    </div>
                `;
                document.getElementById('create-household-btn').addEventListener('click', createHousehold);
                document.getElementById('join-household-btn').addEventListener('click', joinHousehold);
                membersList.innerHTML = '<li class="text-gray-500">No perteneces a ningún hogar.</li>';
            }
        }

        async function loadHouseholdMembers(householdId) {
            const membersList = document.getElementById('household-members-list');
            membersList.innerHTML = '<li>Cargando miembros...</li>';
            const householdRef = doc(db, "households", householdId);
            const householdDoc = await getDoc(householdRef);

            if (householdDoc.exists()) {
                const membersData = householdDoc.data().members; // { uid: { displayName, photoURL }, ... }
                if (membersData && Object.keys(membersData).length > 0) {
                    membersList.innerHTML = Object.values(membersData).map(member => `
                        <li class="flex items-center gap-3 bg-gray-50 p-2 rounded-lg">
                            <img src="${member.photoURL}" alt="${member.displayName}" class="w-8 h-8 rounded-full">
                            <span class="font-medium">${member.displayName}</span>
                        </li>
                    `).join('');
                } else {
                     membersList.innerHTML = '<li class="text-gray-500">No hay miembros en este hogar.</li>';
                }
            } else {
                membersList.innerHTML = '<li class="text-red-500">Error: No se encontró el hogar.</li>';
            }
        }

        // --- LÓGICA DE MANEJO DE DATOS (Firebase) ---

        async function createHousehold() {
            const nameInput = document.getElementById('household-name-input');
            const householdName = nameInput.value.trim();
            if (!householdName) {
                showMessage("Error", "Por favor, introduce un nombre para el hogar.");
                return;
            }

            processingOverlay.classList.remove('hidden');
            processingText.textContent = "Creando hogar...";

            try {
                const batch = writeBatch(db);
                const householdRef = doc(collection(db, "households"));
                
                batch.set(householdRef, {
                    name: householdName,
                    ownerId: currentUser.uid,
                    createdAt: serverTimestamp(),
                    members: {
                        [currentUser.uid]: {
                            displayName: currentUser.displayName,
                            photoURL: currentUser.photoURL
                        }
                    }
                });

                const userRef = doc(db, "users", currentUser.uid);
                batch.update(userRef, { householdId: householdRef.id });

                await batch.commit();
                showMessage("Éxito", `Hogar "${householdName}" creado correctamente.`);
            } catch (error) {
                console.error("Error creating household: ", error);
                showMessage("Error", "No se pudo crear el hogar.");
            } finally {
                processingOverlay.classList.add('hidden');
            }
        }

        async function joinHousehold() {
            const idInput = document.getElementById('join-household-id-input');
            const householdId = idInput.value.trim();
            if (!householdId) {
                showMessage("Error", "Por favor, introduce un ID de hogar válido.");
                return;
            }

            processingOverlay.classList.remove('hidden');
            processingText.textContent = "Uniéndote al hogar...";

            try {
                const householdRef = doc(db, "households", householdId);
                const householdDoc = await getDoc(householdRef);

                if (!householdDoc.exists()) {
                    throw new Error("El hogar no existe.");
                }

                const batch = writeBatch(db);
                const userRef = doc(db, "users", currentUser.uid);
                
                // Añadir miembro al hogar
                const memberData = {
                    [`members.${currentUser.uid}`]: {
                        displayName: currentUser.displayName,
                        photoURL: currentUser.photoURL
                    }
                };
                batch.update(householdRef, memberData);

                // Actualizar perfil de usuario
                batch.update(userRef, { householdId: householdId });

                await batch.commit();
                showMessage("Éxito", "Te has unido al hogar correctamente.");
            } catch (error) {
                console.error("Error joining household: ", error);
                showMessage("Error", `No se pudo unir al hogar. ${error.message}`);
            } finally {
                processingOverlay.classList.add('hidden');
            }
        }
        
        async function leaveHousehold() {
             if (!userProfile || !userProfile.householdId) return;

            processingOverlay.classList.remove('hidden');
            processingText.textContent = "Abandonando el hogar...";
            
            try {
                const batch = writeBatch(db);
                const householdRef = doc(db, "households", userProfile.householdId);
                const userRef = doc(db, "users", currentUser.uid);

                // Quitar al usuario del mapa de miembros del hogar
                batch.update(householdRef, {
                    [`members.${currentUser.uid}`]: deleteField()
                });

                // Quitar el householdId del perfil de usuario
                batch.update(userRef, { householdId: null });

                await batch.commit();
                showMessage("Éxito", "Has abandonado el hogar.");
            } catch (error) {
                console.error("Error leaving household:", error);
                showMessage("Error", "No se pudo abandonar el hogar.");
            } finally {
                processingOverlay.classList.add('hidden');
            }
        }

        // --- FLUJO DE ANÁLISIS DE TICKET ---

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                previewFile(file);
            }
        }

        function handleFileDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('bg-indigo-50');
            const file = e.dataTransfer.files[0];
            if (file) {
                previewFile(file);
            }
        }

        function previewFile(file) {
            currentFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('image-preview-container').innerHTML = `<img src="${e.target.result}" class="max-h-full max-w-full object-contain">`;
            };
            reader.readAsDataURL(file);
            document.getElementById('process-ticket-btn').disabled = false;
        }

        async function processTicket() {
            if (!currentFile) {
                showMessage("Error", "Por favor, selecciona una imagen primero.");
                return;
            }
            
            processingOverlay.classList.remove('hidden');
            processingText.textContent = "Analizando con IA...";

            try {
                const base64Image = await fileToBase64(currentFile);
                const prompt = buildAIPrompt();
                
                const requestBody = {
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inline_data: { mime_type: currentFile.type, data: base64Image } }
                        ]
                    }],
                    generationConfig: {
                        responseMimeType: "application/json",
                    }
                };

                const apiKey = firebaseConfig.apiKey;
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`Error de la API: ${errorBody.error.message}`);
                }

                const data = await response.json();
                const jsonText = data.candidates[0].content.parts[0].text;
                currentTicketData = JSON.parse(jsonText);
                
                showConfirmationModal(currentTicketData);

            } catch (error) {
                console.error("Error processing ticket:", error);
                showMessage("Error de IA", `No se pudo procesar el ticket. ${error.message}`);
            } finally {
                processingOverlay.classList.add('hidden');
            }
        }

        function showConfirmationModal(data) {
            const content = document.getElementById('confirmation-content');
            
            const productRows = data.productos.map((p, index) => {
                // --- VALIDATION LOGIC ---
                if (!categorias[p.categoria_principal]) {
                    p.categoria_principal = Object.keys(categorias)[0];
                    p.familia = null;
                    p.subfamilia = null;
                }
                if (!p.familia || !categorias[p.categoria_principal][p.familia]) {
                    p.familia = Object.keys(categorias[p.categoria_principal])[0];
                    p.subfamilia = null;
                }
                const subfamilias = categorias[p.categoria_principal][p.familia] || [];
                if (!p.subfamilia || !subfamilias.includes(p.subfamilia)) {
                    p.subfamilia = subfamilias[0] || null;
                }
                // --- END VALIDATION ---

                const principalOptions = Object.keys(categorias).map(cat => `<option value="${cat}" ${cat === p.categoria_principal ? 'selected' : ''}>${cat}</option>`).join('');
                const familiaOptions = Object.keys(categorias[p.categoria_principal]).map(fam => `<option value="${fam}" ${fam === p.familia ? 'selected' : ''}>${fam}</option>`).join('');
                const subfamiliaOptions = subfamilias.map(sub => `<option value="${sub}" ${sub === p.subfamilia ? 'selected' : ''}>${sub}</option>`).join('');

                return `
                <div id="product-row-${index}" class="grid grid-cols-12 gap-2 items-center border-b py-2 product-row">
                    <div class="col-span-3"><input type="text" value="${p.nombre}" class="confirm-input confirm-name-input" data-index="${index}" readonly title="La edición del nombre se realizará en la pestaña 'Mis Productos' para mantener la consistencia."></div>
                    <div class="col-span-1"><input type="number" value="${p.cantidad}" class="confirm-input confirm-qty-input" data-index="${index}" step="1" min="1"></div>
                    <div class="col-span-1"><input type="number" value="${p.precio.toFixed(2)}" class="confirm-input confirm-price-input" data-index="${index}" step="0.01"></div>
                    <div class="col-span-2"><select class="confirm-select confirm-cat-principal" id="confirm-cat-principal-${index}" data-index="${index}">${principalOptions}</select></div>
                    <div class="col-span-2"><select class="confirm-select confirm-cat-familia" id="confirm-cat-familia-${index}" data-index="${index}">${familiaOptions}</select></div>
                    <div class="col-span-2"><select class="confirm-select confirm-cat-subfamilia" id="confirm-cat-subfamilia-${index}" data-index="${index}">${subfamiliaOptions}</select></div>
                    <div class="col-span-1 text-center">
                        <button class="delete-product-row-btn text-red-500 hover:text-red-700" data-index="${index}"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                `;
            }).join('');

            content.innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Supermercado</label>
                        <input type="text" id="confirm-supermarket-name" value="${data.supermercado}" class="confirm-input mt-1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Dirección</label>
                        <input type="text" id="confirm-supermarket-address" value="${data.direccion_supermercado || 'No encontrada'}" class="confirm-input mt-1" readonly>
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="grid grid-cols-12 gap-2 font-bold text-sm text-gray-600 px-2">
                        <div class="col-span-3">Nombre</div>
                        <div class="col-span-1">Cant.</div>
                        <div class="col-span-1">Precio</div>
                        <div class="col-span-2">Categoría</div>
                        <div class="col-span-2">Familia</div>
                        <div class="col-span-2">Subfamilia</div>
                        <div class="col-span-1"></div>
                    </div>
                    ${productRows}
                </div>
            `;
            
            updateConfirmationTotal();
            showModal('confirmation-modal');
        }
        
        function updateConfirmationTotal() {
            let total = 0;
            document.querySelectorAll('.confirm-price-input').forEach(input => {
                if(input.closest('.product-row')) { // Only count rows that haven't been deleted
                    total += parseFloat(input.value) || 0;
                }
            });
            document.getElementById('confirmation-total').textContent = total.toFixed(2);
        }

        function updateTicketDataFromModal() {
            const newProductos = [];
            document.querySelectorAll('.product-row').forEach((row, index) => {
                const originalIndex = row.id.split('-')[2];
                const newProduct = {
                    nombre: row.querySelector('.confirm-name-input').value,
                    cantidad: parseInt(row.querySelector('.confirm-qty-input').value, 10),
                    precio: parseFloat(row.querySelector('.confirm-price-input').value),
                    categoria_principal: row.querySelector('.confirm-cat-principal').value,
                    familia: row.querySelector('.confirm-cat-familia').value,
                    subfamilia: row.querySelector('.confirm-cat-subfamilia').value,
                };
                newProductos.push(newProduct);
            });
            currentTicketData.productos = newProductos;
            currentTicketData.total = newProductos.reduce((sum, p) => sum + p.precio, 0);
            currentTicketData.supermercado = document.getElementById('confirm-supermarket-name').value;
            currentTicketData.direccion_supermercado = document.getElementById('confirm-supermarket-address').value;
        }


        function showAssignExpenseModal() {
            hideModal('confirmation-modal');
            const container = document.getElementById('assign-expense-content');
            
            if (!userProfile.householdId) {
                // Si no está en un hogar, todos los gastos son personales. Guardar directamente.
                saveTicketData();
                return;
            }

            container.innerHTML = `
                <p class="mb-4 text-sm">Selecciona para cada producto si es un gasto 'Personal' o para el 'Hogar'.</p>
                <div class="space-y-3">
                    ${currentTicketData.productos.map((p, index) => `
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                            <span class="truncate pr-4">${p.nombre}</span>
                            <div class="flex-shrink-0">
                                <input type="radio" id="personal-${index}" name="assign-${index}" value="personal" class="form-radio text-indigo-600" checked>
                                <label for="personal-${index}" class="ml-1 mr-3">Personal</label>
                                <input type="radio" id="hogar-${index}" name="assign-${index}" value="hogar" class="form-radio text-green-600">
                                <label for="hogar-${index}" class="ml-1">Hogar</label>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            showModal('assign-expense-modal');
        }

        async function saveTicketData() {
            hideModal('assign-expense-modal');
            processingOverlay.classList.remove('hidden');
            processingText.textContent = "Guardando compra...";

            const sanitizeForDocId = (text) => {
                if (!text || typeof text !== 'string') return 'producto_desconocido';
                return text.toLowerCase().replace(/\s+/g, '_').replace(/[^\w-]/g, '');
            }

            // Asignar gastos
            if (userProfile.householdId) {
                currentTicketData.productos.forEach((prod, index) => {
                    const assignment = document.querySelector(`input[name="assign-${index}"]:checked`).value;
                    prod.assignedTo = assignment === 'hogar' ? userProfile.householdId : 'personal';
                });
            } else {
                currentTicketData.productos.forEach(prod => prod.assignedTo = 'personal');
            }

            // Determinar a quién pertenece el ticket principal
            const householdItemsCount = currentTicketData.productos.filter(p => p.assignedTo !== 'personal').length;
            const ticketHouseholdId = householdItemsCount > 0 ? userProfile.householdId : null;

            try {
                const batch = writeBatch(db);
                const ticketRef = doc(collection(db, "tickets"));

                batch.set(ticketRef, {
                    userId: currentUser.uid,
                    householdId: ticketHouseholdId,
                    supermercado: currentTicketData.supermercado,
                    direccion_supermercado: currentTicketData.direccion_supermercado || null,
                    fecha: currentTicketData.fecha,
                    total: currentTicketData.total,
                    productos: currentTicketData.productos,
                    createdAt: serverTimestamp()
                });

                // Actualizar la colección de productos únicos
                for (const product of currentTicketData.productos) {
                    const sanitizedProductName = sanitizeForDocId(product.nombre);
                    const productDocId = `${currentUser.uid}_${sanitizedProductName}`;
                    const productRef = doc(db, "products", productDocId);
                    
                    batch.set(productRef, {
                        userId: currentUser.uid,
                        nombre: product.nombre, // Store the original name
                        categoria_principal: product.categoria_principal,
                        familia: product.familia,
                        subfamilia: product.subfamilia,
                        lastUpdate: serverTimestamp()
                    }, { merge: true });
                }

                await batch.commit();
                showMessage("Éxito", "La compra se ha guardado correctamente.");
                resetTicketAnalysis();

            } catch (error) {
                console.error("Error saving ticket data:", error);
                showMessage("Error", `No se pudo guardar la compra. Detalles: ${error.message}`);
            } finally {
                processingOverlay.classList.add('hidden');
            }
        }

        // --- LÓGICA DEL DASHBOARD ---

        function renderDashboard() {
            if (!currentUser) return;
            const year = document.getElementById('filter-year').value;
            const month = document.getElementById('filter-month').value;
            const context = document.getElementById('context-filter').value;

            let basePurchases = allPurchases;

            // Apply chart filters if they exist
            if (chartFilter.type && chartFilter.value) {
                if (chartFilter.type === 'supermarket') {
                    basePurchases = basePurchases.filter(p => p.supermercado === chartFilter.value);
                } else if (chartFilter.type === 'category') {
                    basePurchases = basePurchases.filter(p => p.productos.some(prod => prod.categoria_principal === chartFilter.value));
                }
                 document.getElementById('reset-filter-btn').classList.remove('hidden');
                 document.getElementById('history-title').textContent = `Historial de: ${chartFilter.value}`;
            } else {
                document.getElementById('reset-filter-btn').classList.add('hidden');
                document.getElementById('history-title').textContent = 'Historial de Compras';
            }

            currentFilteredPurchases = basePurchases.filter(p => {
                const purchaseDate = new Date(p.fecha);
                const yearMatch = year === 'all' || purchaseDate.getFullYear() == year;
                const monthMatch = month === 'all' || (purchaseDate.getMonth() + 1) == month;
                
                let contextMatch = false;
                if (context === 'all') {
                    contextMatch = true;
                } else if (context === 'personal') {
                    contextMatch = p.userId === currentUser.uid && !p.householdId;
                } else if (context === 'household') {
                    contextMatch = p.householdId === userProfile.householdId;
                }

                return yearMatch && monthMatch && contextMatch;
            });
            
            // Renderizar componentes del dashboard
            renderSummaryCards();
            renderSupermarketChart();
            renderCategoryChart();
            renderPurchasesHistory();
        }
        
        // --- HELPERS Y UTILIDADES ---
        
        function buildAIPrompt() {
            // Este prompt es crucial. Debe ser muy detallado.
            return `
                Analiza la imagen de este ticket de supermercado. Extrae la siguiente información en un formato JSON estricto. No incluyas nada fuera del objeto JSON.
                
                El JSON debe tener la siguiente estructura:
                {
                  "supermercado": "string", // Nombre del supermercado
                  "direccion_supermercado": "string", // Dirección física del supermercado si aparece, si no, null.
                  "fecha": "string", // Fecha en formato YYYY-MM-DD
                  "productos": [
                    {
                      "nombre": "string", // Nombre del producto
                      "cantidad": number, // Cantidad, por defecto 1
                      "precio": number, // Precio total del producto (precio unitario * cantidad)
                      "categoria_principal": "string", // Categoría principal
                      "familia": "string", // Familia
                      "subfamilia": "string" // Subfamilia
                    }
                  ],
                  "total": number // Suma total del ticket
                }

                Reglas de categorización (MUY IMPORTANTE):
                - Asigna a cada producto una categoría de los 3 niveles: categoria_principal, familia y subfamilia.
                - Utiliza ÚNICA Y EXCLUSIVAMENTE las siguientes categorías. No inventes ninguna.
                - Si un producto no encaja, usa 'OTROS GASTOS' -> 'Varios' -> 'Sin especificar'.

                Jerarquía de Categorías Permitidas:
                - 🛒 ALIMENTOS Y BEBIDAS
                  - 🍓🥦 Frutas y Verduras: [🥬 Verduras, 🥔 Tubérculos, 🍄 Setas y Hongos, 🍎 Frutas Frescas, 🍇 Frutas Deshidratadas]
                  - 🥩🍗 Carnes y Aves: [🐔 Aves, 🐄 Ternera, 🐖 Cerdo, 🐑 Cordero, 🌭 Embutidos]
                  - 🐟🦐 Pescados y Mariscos: [🐠 Pescado Fresco, 🦞 Marisco Fresco, 🧊 Pescado Congelado, 🥫 Conservas de Pescado]
                  - 🥛🥚 Lácteos y Huevos: [🥛 Leche, 🍮 Yogures y Postres Lácteos, 🧀 Quesos, 🥚 Huevos]
                  - 🍞🥐 Panadería y Pastelería: ["🥖 Pan", "🍩 Bollería", "🍰 Pasteles", "🍪 Galletas"]
                  - 🌾🫘 Cereales y Legumbres: ["🍚 Arroz", "🍝 Pasta", "🥣 Legumbres Secas", "🥣 Cereales de Desayuno"]
                  - 🍾🍶 Aceites, Vinagres y Salsas: ["🫒 Aceites Comestibles", "🍇 Vinagres", "🥫 Salsas Preparadas", "🧂 Condimentos y Especias"]
                  - 🥫🥡 Conservas y Platos Preparados: ["🫙 Conservas Vegetales", "🥩 Conservas Cárnicas", "🍲 Platos Listos para Consumir"]
                  - 🧊 Congelados: ["🥦 Verduras Congeladas", "🐟 Pescado Congelado", "🍕 Comidas Preparadas Congeladas", "🍨 Helados"]
                  - 🥤 Bebidas: ["🧃 Bebidas No Alcohólicas", "🍺 Bebidas Alcohólicas"]
                  - 🥨🍬 Snacks y Dulces: ["🍟 Patatas Fritas y Aperitivos", "🍫 Chocolates y Golosinas", "🥜 Frutos Secos"]
                  - ❤️‍🩹 Dietéticos y Especiales: ["🚫🌾 Sin Gluten", "🚫🥛 Sin Lactosa", "🌱 Orgánicos/Biológicos", "🌿 Vegetarianos/Veganos"]
                - 🏠 HOGAR Y LIMPIEZA
                  - 🧼🧽 Productos de Limpieza: ["🧴 Limpiadores Multiusos", "🧺 Detergentes para Ropa", "🚽 Productos de Baño y Cocina", "🦟 Insecticidas"]
                  - 🍴🍽️ Menaje y Utensilios: ["🍷 Vajilla y Cristalería", "🍳 Batería de Cocina", "🔌 Pequeños Electrodomésticos"]
                  - 🏡 Cuidado del Hogar: ["🧻 Papel de Cocina y Servilletas", "🗑️ Bolsas de Basura", "🔋💡 Pilas y Bombillas", "🌬️ Ambientadores"]
                - 🧴 HIGIENE Y CUIDADO PERSONAL
                  - 🚿🧼 Higiene Diaria: ["🧴 Champú y Acondicionador", "🧼 Gel de Ducha y Jabón", "🦷 Pasta de Dientes y Cuidado Bucal", "💨 Desodorantes"]
                  - 💆‍♀️💅 Cuidado Facial y Corporal: ["🧴 Cremas y Lociones", "💄 Maquillaje", "☀️ Protector Solar"]
                  - ⚕️💊 Farmacia/Parafarmacia: ["💊 Medicamentos Sin Receta", "💪 Suplementos y Vitaminas", "🩹 Material de Primeros Auxilios"]
                - 🐾 MASCOTAS
                  - 🦴🍖 Alimento para Mascotas: ["🐶 Perros", "🐱 Gatos", "🐹 Otras Mascotas"]
                  - 🧸 Accesorios para Mascotas: ["🎾 Juguetes", "🧼 Productos de Higiene para Mascotas"]
                - 💸 OTROS GASTOS
                  - 🛍️ Varios: ["🎁 Regalos", "📰 Prensa y Revistas", "❓ Sin especificar"]

                Analiza cuidadosamente cada línea del ticket para extraer el nombre, la cantidad y el precio. Si el precio no es claro, haz una estimación razonable. El total debe ser la suma de los precios de los productos.
            `;
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        // --- INICIALIZACIÓN DE LA APP ---
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
        });
        
        function showMessage(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            showModal('message-modal');
        }

        function showModal(id) {
            const modal = document.getElementById(id);
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
        }

        function hideModal(id) {
            const modal = document.getElementById(id);
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
        
        function showWelcomeModal() {
            showModal('welcome-modal');
        }

        function resetAppState() {
            allPurchases = [];
            allUserProducts = [];
            currentFilteredPurchases = [];
            selectedPurchases.clear();
            if (supermarketChart) supermarketChart.destroy();
            if (categoryChart) categoryChart.destroy();
            resetTicketAnalysis();
            document.getElementById('purchases-history').innerHTML = '';
            document.getElementById('products-table').innerHTML = '';
        }
        
        function resetTicketAnalysis() {
            currentFile = null;
            currentTicketData = null;
            document.getElementById('file-upload').value = '';
            document.getElementById('image-preview-container').innerHTML = '<p>Aquí verás la imagen de tu ticket.</p>';
            document.getElementById('process-ticket-btn').disabled = true;
        }

        function populateFilters() {
            const years = [...new Set(allPurchases.map(p => new Date(p.fecha).getFullYear()))].sort((a, b) => b - a);
            const yearSelect = document.getElementById('filter-year');
            yearSelect.innerHTML = '<option value="all">Todos los Años</option>' + years.map(y => `<option value="${y}">${y}</option>`).join('');
            
            const monthSelect = document.getElementById('filter-month');
            const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            monthSelect.innerHTML = '<option value="all">Todos los Meses</option>' + months.map((m, i) => `<option value="${i+1}">${m}</option>`).join('');
        }
        
        function updateContextFilter(profile) {
            const contextSelect = document.getElementById('context-filter');
            let options = '<option value="personal">Gastos Personales</option>';
            if (profile && profile.householdId) {
                options += `<option value="household">Gastos del Hogar</option>`;
            }
            options += '<option value="all">Ver Todo</option>';
            contextSelect.innerHTML = options;
        }
        
        function renderSummaryCards() {
            const totalExpense = currentFilteredPurchases.reduce((sum, p) => sum + p.total, 0);
            document.getElementById('total-expense').textContent = `${totalExpense.toFixed(2)} €`;
            document.getElementById('total-purchases').textContent = currentFilteredPurchases.length;
            
            // Monthly comparison logic
            const year = document.getElementById('filter-year').value;
            const month = document.getElementById('filter-month').value;
            const comparisonDiv = document.getElementById('monthly-comparison');

            if (year !== 'all' && month !== 'all') {
                const currentMonth = parseInt(month);
                const currentYear = parseInt(year);

                let prevMonth = currentMonth - 1;
                let prevYear = currentYear;
                if (prevMonth === 0) {
                    prevMonth = 12;
                    prevYear--;
                }

                const prevMonthPurchases = allPurchases.filter(p => {
                    const d = new Date(p.fecha);
                    return d.getFullYear() === prevYear && (d.getMonth() + 1) === prevMonth;
                });
                const prevMonthTotal = prevMonthPurchases.reduce((sum, p) => sum + p.total, 0);

                if (prevMonthTotal > 0) {
                    const percentageChange = ((totalExpense - prevMonthTotal) / prevMonthTotal) * 100;
                    const color = percentageChange > 0 ? 'text-red-500' : 'text-green-500';
                    const icon = percentageChange > 0 ? '<i class="fas fa-arrow-up"></i>' : '<i class="fas fa-arrow-down"></i>';
                    comparisonDiv.innerHTML = `<span class="${color}">${icon} ${percentageChange.toFixed(1)}%</span>`;
                } else if (totalExpense > 0) {
                    comparisonDiv.innerHTML = `<span class="text-green-500">--</span>`;
                }
                 else {
                    comparisonDiv.textContent = 'N/A';
                }
            } else {
                comparisonDiv.textContent = '--';
            }
        }

        function renderPurchasesHistory() {
            const tbody = document.getElementById('purchases-history');
            if (currentFilteredPurchases.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">No hay compras que mostrar para los filtros seleccionados.</td></tr>';
                return;
            }

            tbody.innerHTML = currentFilteredPurchases
                .sort((a, b) => new Date(b.fecha) - new Date(a.fecha))
                .map(p => `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="w-4 p-4">
                        <input type="checkbox" data-id="${p.id}" class="purchase-checkbox w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                    </td>
                    <td class="px-6 py-4">${p.fecha}</td>
                    <td class="px-6 py-4 font-medium text-gray-900">${p.supermercado}</td>
                    <td class="px-6 py-4">${p.total.toFixed(2)} €</td>
                    <td class="px-6 py-4">${p.householdId ? 'Hogar' : 'Personal'}</td>
                </tr>
            `).join('');
            
            // Add event listeners to new checkboxes
            document.querySelectorAll('.purchase-checkbox').forEach(cb => {
                cb.addEventListener('change', handlePurchaseSelect);
            });
        }
        
        function renderProductsTable() {
            const tbody = document.getElementById('products-table');
            if (allUserProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-gray-500">Aún no has escaneado ningún producto.</td></tr>';
                return;
            }

            const productCounts = allPurchases.flatMap(p => p.productos).reduce((acc, prod) => {
                const key = prod.nombre.toLowerCase();
                acc[key] = (acc[key] || 0) + 1;
                return acc;
            }, {});

            tbody.innerHTML = allUserProducts
                .sort((a, b) => a.nombre.localeCompare(b.nombre)) // Sort alphabetically
                .map(p => {
                    const count = productCounts[p.nombre.toLowerCase()] || 0;
                    return `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-6 py-4 font-medium text-gray-900">${p.nombre}</td>
                        <td class="px-6 py-4">${p.categoria_principal}</td>
                        <td class="px-6 py-4">${p.familia}</td>
                        <td class="px-6 py-4">${p.subfamilia}</td>
                        <td class="px-6 py-4 text-center">${count}</td>
                        <td class="px-6 py-4 text-center">
                            <button class="edit-product-btn text-indigo-600 hover:text-indigo-900" data-id="${p.id}">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                        </td>
                    </tr>
                `}).join('');
        }

        function openEditProductModal(productId) {
            const product = allUserProducts.find(p => p.id === productId);
            if (!product) return;

            document.getElementById('edit-product-id').value = product.id;
            document.getElementById('edit-product-original-name').value = product.nombre;
            document.getElementById('edit-product-name').value = product.nombre;
            
            populatePrincipalDropdown('edit-category-principal', product.categoria_principal);
            populateFamiliaDropdown(product.familia, 'edit-category-familia', product.categoria_principal);
            populateSubfamiliaDropdown(product.subfamilia, 'edit-category-subfamilia', product.categoria_principal, product.familia);

            showModal('edit-product-modal');
        }

        function populatePrincipalDropdown(selectId, selectedValue) {
            const select = document.getElementById(selectId);
            select.innerHTML = Object.keys(categorias).map(cat => `<option value="${cat}" ${cat === selectedValue ? 'selected' : ''}>${cat}</option>`).join('');
        }

        function populateFamiliaDropdown(selectedValue, selectId, principalValue) {
            const select = document.getElementById(selectId);
            if (categorias[principalValue]) {
                select.innerHTML = Object.keys(categorias[principalValue]).map(fam => `<option value="${fam}" ${fam === selectedValue ? 'selected' : ''}>${fam}</option>`).join('');
            } else {
                select.innerHTML = '';
            }
            populateSubfamiliaDropdown(null, selectId.replace('familia', 'subfamilia'), principalValue, select.value);
        }

        function populateSubfamiliaDropdown(selectedValue, selectId, principalValue, familiaValue) {
            const select = document.getElementById(selectId);
            if (categorias[principalValue] && categorias[principalValue][familiaValue]) {
                select.innerHTML = categorias[principalValue][familiaValue].map(sub => `<option value="${sub}" ${sub === selectedValue ? 'selected' : ''}>${sub}</option>`).join('');
            } else {
                select.innerHTML = '';
            }
        }

        async function saveProductChanges() {
            const productId = document.getElementById('edit-product-id').value;
            const originalName = document.getElementById('edit-product-original-name').value;
            const newName = document.getElementById('edit-product-name').value;
            const newCat = document.getElementById('edit-category-principal').value;
            const newFam = document.getElementById('edit-category-familia').value;
            const newSub = document.getElementById('edit-category-subfamilia').value;

            hideModal('edit-product-modal');
            processingOverlay.classList.remove('hidden');
            processingText.textContent = "Actualizando producto y tickets...";

            try {
                const batch = writeBatch(db);
                
                // 1. Update the product document itself
                const productRef = doc(db, "products", productId);
                batch.update(productRef, {
                    nombre: newName,
                    categoria_principal: newCat,
                    familia: newFam,
                    subfamilia: newSub
                });

                // 2. Update all tickets containing this product
                for (const ticket of allPurchases) {
                    let ticketModified = false;
                    const updatedProductos = ticket.productos.map(p => {
                        if (p.nombre === originalName) {
                            ticketModified = true;
                            return { ...p, nombre: newName, categoria_principal: newCat, familia: newFam, subfamilia: newSub };
                        }
                        return p;
                    });

                    if (ticketModified) {
                        const ticketRef = doc(db, "tickets", ticket.id);
                        batch.update(ticketRef, { productos: updatedProductos });
                    }
                }

                await batch.commit();
                showMessage("Éxito", "El producto y todas las compras asociadas han sido actualizados.");

            } catch (error) {
                console.error("Error updating product:", error);
                showMessage("Error", `No se pudieron guardar los cambios. ${error.message}`);
            } finally {
                processingOverlay.classList.add('hidden');
            }
        }


        function renderSupermarketChart() {
            const ctx = document.getElementById('supermarket-chart').getContext('2d');
            const data = currentFilteredPurchases.reduce((acc, p) => {
                acc[p.supermercado] = (acc[p.supermercado] || 0) + p.total;
                return acc;
            }, {});

            if (supermarketChart) supermarketChart.destroy();
            supermarketChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: chartColors,
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    legend: { position: 'bottom' },
                    onClick: (evt, elements) => {
                        if (elements.length > 0) {
                            const clickedLabel = supermarketChart.data.labels[elements[0].index];
                            chartFilter = { type: 'supermarket', value: clickedLabel };
                            renderDashboard();
                        }
                    }
                }
            });
        }
        
        function renderCategoryChart() {
             const ctx = document.getElementById('category-chart').getContext('2d');
            const data = {};

            currentFilteredPurchases.forEach(purchase => {
                purchase.productos.forEach(product => {
                    let key;
                    if (categoryChartLevel === 1) {
                        key = product.categoria_principal;
                    } else if (categoryChartLevel === 2 && product.categoria_principal === selectedPrincipal) {
                        key = product.familia;
                    } else if (categoryChartLevel === 3 && product.categoria_principal === selectedPrincipal && product.familia === selectedFamilia) {
                        key = product.subfamilia;
                    }

                    if (key) {
                        data[key] = (data[key] || 0) + product.precio;
                    }
                });
            });

            if (categoryChart) categoryChart.destroy();
            categoryChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: chartColors,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    legend: { position: 'bottom' },
                    onClick: handleCategoryChartClick
                }
            });
        }
        
        function resetChartFilter() {
            chartFilter = { type: null, value: null };
            renderDashboard();
        }

        function handleCategoryChartClick(evt, elements) {
            if (elements.length > 0) {
                const clickedLabel = categoryChart.data.labels[elements[0].index];
                if (categoryChartLevel === 1) {
                    chartFilter = { type: 'category', value: clickedLabel };
                    renderDashboard();
                    
                    selectedPrincipal = clickedLabel;
                    categoryChartLevel = 2;
                    document.getElementById('category-chart-title').textContent = `Desglose de: ${selectedPrincipal}`;
                    document.getElementById('category-chart-back-btn').classList.remove('hidden');
                    renderCategoryChart();
                } else if (categoryChartLevel === 2) {
                    selectedFamilia = clickedLabel;
                    categoryChartLevel = 3;
                    document.getElementById('category-chart-title').textContent = `Desglose de: ${selectedFamilia}`;
                    renderCategoryChart();
                }
            }
        }

        function handleCategoryChartBack() {
            if (categoryChartLevel === 3) {
                categoryChartLevel = 2;
                 document.getElementById('category-chart-title').textContent = `Desglose de: ${selectedPrincipal}`;
            } else if (categoryChartLevel === 2) {
                categoryChartLevel = 1;
                document.getElementById('category-chart-title').textContent = 'Gasto por Categoría Principal';
                document.getElementById('category-chart-back-btn').classList.add('hidden');
                resetChartFilter();
            }
            renderCategoryChart();
        }
        
        function handleSelectAll(e) {
            const isChecked = e.target.checked;
            document.querySelectorAll('.purchase-checkbox').forEach(cb => {
                cb.checked = isChecked;
                const id = cb.dataset.id;
                if (isChecked) {
                    selectedPurchases.add(id);
                } else {
                    selectedPurchases.delete(id);
                }
            });
            updateDeleteButtonState();
        }

        function handlePurchaseSelect(e) {
            const id = e.target.dataset.id;
            if (e.target.checked) {
                selectedPurchases.add(id);
            } else {
                selectedPurchases.delete(id);
            }
            updateDeleteButtonState();
        }
        
        function updateDeleteButtonState() {
            document.getElementById('delete-selected-btn').disabled = selectedPurchases.size === 0;
        }

        function confirmDeleteSelected() {
            const modal = document.getElementById('delete-confirm-modal');
            document.getElementById('delete-modal-title').textContent = 'Eliminar Compras';
            document.getElementById('delete-modal-message').textContent = `¿Estás seguro de que quieres eliminar ${selectedPurchases.size} compra(s)? Esta acción no se puede deshacer.`;
            showModal('delete-confirm-modal');

            document.getElementById('delete-cancel-btn').onclick = () => hideModal('delete-confirm-modal');
            document.getElementById('delete-confirm-btn').onclick = async () => {
                hideModal('delete-confirm-modal');
                processingOverlay.classList.remove('hidden');
                processingText.textContent = 'Eliminando...';
                try {
                    const batch = writeBatch(db);
                    selectedPurchases.forEach(id => {
                        batch.delete(doc(db, 'tickets', id));
                    });
                    await batch.commit();
                    showMessage('Éxito', 'Las compras seleccionadas han sido eliminadas.');
                    selectedPurchases.clear();
                    updateDeleteButtonState();
                } catch (error) {
                    console.error("Error deleting purchases:", error);
                    showMessage('Error', 'No se pudieron eliminar las compras.');
                } finally {
                    processingOverlay.classList.add('hidden');

                }
            };
        }

        function handleAuthError(error) {
            if (error.code === 'auth/unauthorized-domain') {
                showMessage(
                    "Error de Configuración", 
                    "El dominio actual no está autorizado. Ve a tu proyecto de Firebase -> Authentication -> Sign-in method -> Google y añade el dominio desde el que ejecutas la app a la lista de 'Dominios autorizados'."
                );
            } else {
                console.error("Error de autenticación:", error);
                showMessage("Error de Autenticación", `No se pudo iniciar sesión. Error: ${error.message}`);
            }
        }
        
        window.addEventListener('click', (e) => {
            const userMenu = document.getElementById('user-menu');
            if (userMenu && !userMenu.classList.contains('hidden') && !authContainer.contains(e.target)) {
                userMenu.classList.add('hidden');
            }
        });
    </script>
</body>
</html>

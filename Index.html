<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Gastos IA</title>
    
    <!-- Meta tags para PWA -->
    <meta name="theme-color" content="#4f46e5"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/icon-192x192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-button { padding: 1rem; border-bottom: 3px solid transparent; transition: all 0.3s ease; cursor: pointer; }
        .tab-button.active { border-color: #4f46e5; color: #4f46e5; background-color: #eef2ff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .loader { border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid #4f46e5; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { transition: opacity 0.3s ease; }
        #app-container.hidden, #landing-page.hidden { display: none; }
        .table-actions button:disabled { background-color: #d1d5db; cursor: not-allowed; }
        .achievement.unlocked { opacity: 1; }
        .achievement.locked { opacity: 0.4; filter: grayscale(100%); }
        .premium-feature { position: relative; border: 2px dashed #d1d5db; padding: 2rem; border-radius: 0.5rem; margin-top: 1rem; }
        .premium-overlay { position: absolute; inset: 0; background-color: rgba(249, 250, 251, 0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; border-radius: 0.5rem; cursor: pointer; }
        #ads-banner.hidden { display: none; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- LANDING PAGE (Visible para usuarios no logueados) -->
    <div id="landing-page">
        <header class="container mx-auto p-6 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-indigo-600">Gestor de Gastos IA</h1>
            <button id="landing-login-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">Iniciar Sesión</button>
        </header>

        <main>
            <section class="text-center py-20 px-6 bg-white">
                <h2 class="text-4xl md:text-5xl font-extrabold text-gray-900 leading-tight">La forma más inteligente de controlar tus gastos de supermercado.</h2>
                <p class="mt-4 text-lg md:text-xl text-gray-600 max-w-3xl mx-auto">Convierte tus tickets en datos, descubre tus hábitos de consumo y deja que nuestro Chef Inteligente te diga qué cocinar para no desperdiciar comida.</p>
                <button id="landing-register-btn" class="mt-8 bg-indigo-600 text-white font-bold py-4 px-8 rounded-lg text-lg hover:bg-indigo-700 transition-colors">Regístrate Gratis con Google</button>
            </section>

            <section class="py-20">
                <div class="container mx-auto px-6 text-center">
                    <h3 class="text-3xl font-bold mb-16">Todo lo que necesitas para ahorrar de verdad</h3>
                    <div class="grid md:grid-cols-3 gap-12">
                        <div class="bg-white p-8 rounded-lg shadow-md">
                            <i class="fas fa-camera fa-3x text-indigo-500"></i>
                            <h4 class="text-xl font-bold mt-4 mb-2">Escanea y Olvídate</h4>
                            <p class="text-gray-600">Saca una foto a tu ticket y nuestra IA extraerá cada producto, precio y categoría por ti. Di adiós a la entrada manual de datos.</p>
                        </div>
                        <div class="bg-white p-8 rounded-lg shadow-md">
                            <i class="fas fa-chart-pie fa-3x text-indigo-500"></i>
                            <h4 class="text-xl font-bold mt-4 mb-2">Entiende tus Gastos</h4>
                            <p class="text-gray-600">Con gráficos interactivos y una categorización detallada, sabrás exactamente a dónde va tu dinero. Toma el control de tus finanzas.</p>
                        </div>
                        <div class="bg-white p-8 rounded-lg shadow-md">
                            <i class="fas fa-utensils fa-3x text-indigo-500"></i>
                            <h4 class="text-xl font-bold mt-4 mb-2">Cocina con lo que Tienes</h4>
                            <p class="text-gray-600">Nuestro Chef Inteligente analiza tu despensa virtual y te sugiere recetas deliciosas para que no desperdicies comida.</p>
                        </div>
                    </div>
                </div>
            </section>

            <section class="py-20 bg-white text-center">
                <h3 class="text-3xl font-bold">¿Listo para empezar a ahorrar?</h3>
                <button id="final-cta-btn" class="mt-8 bg-indigo-600 text-white font-bold py-4 px-8 rounded-lg text-lg hover:bg-indigo-700 transition-colors">Crea tu Cuenta Gratis</button>
            </section>
        </main>
    </div>


    <!-- CONTENEDOR PRINCIPAL DE LA APP (Oculto inicialmente) -->
    <div id="app-container" class="hidden">
        <div class="container mx-auto p-4 md:p-8">
            <header class="mb-8 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Gestor de Gastos IA v2.0</h1>
                    <p class="text-gray-600 mt-1">Tu asistente de ahorro inteligente.</p>
                </div>
                <div id="auth-container"></div>
            </header>
            
            <div id="app-content">
                <!-- Navegación por pestañas -->
                <div class="mb-8 border-b border-gray-200">
                    <nav class="flex flex-wrap -mb-px" aria-label="Tabs">
                        <button class="tab-button active" data-tab="analizar-ticket"><i class="fas fa-receipt mr-2"></i> Analizar Ticket</button>
                        <button class="tab-button" data-tab="mis-gastos"><i class="fas fa-chart-pie mr-2"></i> Mis Gastos</button>
                        <button class="tab-button" data-tab="mis-productos"><i class="fas fa-tag mr-2"></i> Mis Productos</button>
                        <button class="tab-button" data-tab="lista-compra"><i class="fas fa-list-check mr-2"></i> Lista de Compra</button>
                        <button class="tab-button" data-tab="chef-inteligente"><i class="fas fa-utensils mr-2"></i> Chef Inteligente</button>
                        <button class="tab-button" data-tab="logros"><i class="fas fa-trophy mr-2"></i> Mis Logros</button>
                        <button class="tab-button" data-tab="premium"><i class="fas fa-star mr-2"></i> Premium</button>
                    </nav>
                </div>

                <!-- Contenido de las pestañas -->
                <main>
                    <!-- Pestaña: Analizar Ticket -->
                    <div id="analizar-ticket" class="tab-content active">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                <h2 class="text-xl font-semibold mb-4">1. Sube tu Ticket</h2>
                                <div id="image-uploader" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                                    <div class="space-y-1 text-center">
                                        <i class="fas fa-camera fa-3x text-gray-400"></i>
                                        <div class="flex text-sm text-gray-600">
                                            <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                                                <span>Sube un archivo</span>
                                                <input id="file-upload" name="file-upload" type="file" class="sr-only" accept="image/*">
                                            </label>
                                            <p class="pl-1">o arrástralo aquí</p>
                                        </div>
                                        <p class="text-xs text-gray-500">PNG, JPG, GIF hasta 10MB</p>
                                    </div>
                                </div>
                                <button id="process-ticket-btn" class="mt-6 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 disabled:bg-gray-400" disabled>
                                    <i class="fas fa-cogs mr-2"></i> Procesar Ticket
                                </button>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                <h2 class="text-xl font-semibold mb-4">2. Vista Previa</h2>
                                <div id="image-preview-container" class="w-full h-64 bg-gray-100 rounded-lg flex items-center justify-center text-gray-500">
                                    <p>Aquí verás la imagen de tu ticket.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pestaña: Mis Gastos -->
                    <div id="mis-gastos" class="tab-content">
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-8">
                            <h2 class="text-xl font-semibold mb-4">Filtros</h2>
                            <div class="flex flex-wrap gap-4">
                                <select id="filter-year" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full md:w-auto p-2.5"></select>
                                <select id="filter-month" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full md:w-auto p-2.5"></select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 flex flex-col justify-center items-center">
                                <h3 class="text-lg font-semibold mb-2">Gasto Total</h3>
                                <p id="total-expense" class="text-3xl font-bold text-indigo-600">0,00 €</p>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 flex flex-col justify-center items-center">
                                <h3 class="text-lg font-semibold mb-2">Nº de Compras</h3>
                                <p id="total-purchases" class="text-3xl font-bold text-indigo-600">0</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                <h3 class="text-lg font-semibold mb-4 text-center">Gasto por Supermercado</h3>
                                <div class="h-64 md:h-80"><canvas id="supermarket-chart"></canvas></div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 id="category-chart-title" class="text-lg font-semibold">Gasto por Categoría Principal</h3>
                                    <button id="category-chart-back-btn" class="hidden text-sm text-indigo-600 hover:underline"><i class="fas fa-arrow-left mr-1"></i> Volver</button>
                                </div>
                                <div class="h-64 md:h-80"><canvas id="category-chart"></canvas></div>
                            </div>
                        </div>
                         <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">Historial de Compras</h3>
                                <div class="table-actions">
                                    <button id="delete-selected-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300" disabled>
                                        <i class="fas fa-trash mr-2"></i>Eliminar seleccionados
                                    </button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="p-4">
                                                <input type="checkbox" id="select-all-checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                                            </th>
                                            <th scope="col" class="px-6 py-3">Fecha</th>
                                            <th scope="col" class="px-6 py-3">Supermercado</th>
                                            <th scope="col" class="px-6 py-3">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="purchases-history"></tbody>
                                </table>
                            </div>
                        </div>
                        <div id="ads-banner" class="hidden mt-8 p-4 bg-gray-200 rounded-lg text-center text-gray-600">
                            <p class="text-sm">Espacio para publicidad (Visible solo para usuarios gratuitos)</p>
                            <!-- Aquí se pegaría el código de Google AdSense -->
                        </div>
                    </div>

                    <!-- Pestaña: Mis Productos -->
                    <div id="mis-productos" class="tab-content">
                         <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h2 class="text-xl font-semibold mb-4">Gestión de Productos</h2>
                            <p class="text-sm text-gray-600 mb-4">Aquí puedes ver todos los productos únicos que has comprado y corregir su categorización si es necesario. Los cambios se aplicarán a todas las compras pasadas.</p>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">Producto</th>
                                            <th scope="col" class="px-6 py-3">Categoría Principal</th>
                                            <th scope="col" class="px-6 py-3">Familia</th>
                                            <th scope="col" class="px-6 py-3">Subfamilia</th>
                                            <th scope="col" class="px-6 py-3">Nº Compras</th>
                                            <th scope="col" class="px-6 py-3">Tendencia de Precio</th>
                                        </tr>
                                    </thead>
                                    <tbody id="products-table"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pestaña: Lista de la Compra -->
                    <div id="lista-compra" class="tab-content">
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h2 class="text-xl font-semibold mb-4">Lista de la Compra Inteligente</h2>
                            <div class="flex gap-2 mb-4">
                                <input type="text" id="add-item-input" placeholder="Añadir producto..." class="flex-grow bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5">
                                <button id="add-item-btn" class="bg-indigo-600 text-white px-4 rounded-lg"><i class="fas fa-plus"></i></button>
                            </div>
                            <div id="shopping-list" class="space-y-2 mb-6">
                                <!-- Los productos de la lista se añadirán aquí -->
                            </div>
                            <div class="border-t pt-4">
                                 <h3 class="font-semibold mb-2">Sugerencias Predictivas</h3>
                                 <p class="text-sm text-gray-600 mb-4">Basado en tus hábitos de consumo, puede que necesites reponer esto:</p>
                                 <button id="suggest-items-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                                    <i class="fas fa-wand-magic-sparkles mr-2"></i>Generar Sugerencias
                                 </button>
                                 <div id="suggestions-container" class="mt-4 space-y-2"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Pestaña: Chef Inteligente -->
                    <div id="chef-inteligente" class="tab-content">
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h2 class="text-xl font-semibold mb-4">Chef Inteligente 🧑‍🍳</h2>
                            <p class="text-sm text-gray-600 mb-4">¿No sabes qué cocinar? Dime qué tipo de comida te apetece y te daré ideas basadas en los ingredientes que probablemente tienes en tu despensa.</p>
                            <div class="flex gap-2 mb-4">
                                <input type="text" id="chef-query-input" placeholder="Ej: ¿Qué puedo hacer para cenar rápido?" class="flex-grow bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5">
                                <button id="chef-ask-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                                    Preguntar
                                 </button>
                            </div>
                            <div id="chef-suggestions-container" class="mt-6">
                                <!-- Las sugerencias de recetas aparecerán aquí -->
                            </div>
                        </div>
                    </div>

                    <!-- Pestaña: Mis Logros -->
                    <div id="logros" class="tab-content">
                         <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h2 class="text-xl font-semibold mb-4">Mis Logros</h2>
                            <div id="achievements-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 text-center mb-8">
                                <!-- Los logros se generarán aquí -->
                            </div>
                            <h2 class="text-xl font-semibold mb-4 border-t pt-6">Reto Semanal</h2>
                            <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                                <div class="flex items-center">
                                    <i class="fas fa-bullseye fa-2x text-blue-500 mr-4"></i>
                                    <div>
                                        <h3 class="font-bold">Gasta un 10% menos en "Snacks"</h3>
                                        <p class="text-sm text-gray-600">¡Acepta el reto y mejora tus hábitos de ahorro!</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pestaña: Premium -->
                    <div id="premium" class="tab-content">
                         <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h2 class="text-xl font-semibold mb-4">Funciones Premium</h2>
                            
                            <div class="premium-feature">
                                <h3 class="text-lg font-semibold mb-2">Módulo Avanzado de Análisis de Precios</h3>
                                <p class="text-gray-600">Gráficos de evolución, comparador de supermercados y alertas de ofertas.</p>
                                <div class="premium-overlay">
                                    <i class="fas fa-lock fa-2x text-yellow-500 mb-2"></i>
                                    <p class="font-semibold">Función Premium</p>
                                    <button class="mt-4 bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg upgrade-btn">¡Actualiza ahora!</button>
                                </div>
                            </div>

                            <div class="premium-feature">
                                <h3 class="text-lg font-semibold mb-2">Módulo de Presupuestos Inteligentes</h3>
                                <p class="text-gray-600">Define límites por categoría, recibe alertas en tiempo real y obtén recomendaciones de ahorro.</p>
                                 <div class="premium-overlay">
                                    <i class="fas fa-lock fa-2x text-yellow-500 mb-2"></i>
                                    <p class="font-semibold">Función Premium</p>
                                    <button class="mt-4 bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg upgrade-btn">¡Actualiza ahora!</button>
                                </div>
                            </div>
                         </div>
                    </div>

                </main>
            </div>
        </div>
    </div>

    <!-- Overlay de procesamiento -->
    <div id="processing-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-lg font-medium">Procesando...</p>
        </div>
    </div>

    <!-- Modal para mostrar mensajes genéricos -->
    <div id="message-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full mx-auto">
            <h3 id="modal-title" class="text-lg font-bold"></h3>
            <p id="modal-message" class="mt-2 text-sm text-gray-600"></p>
            <div class="mt-4 text-right">
                <button id="modal-close-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación de Ticket -->
    <div id="confirmation-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-auto max-h-[90vh] flex flex-col">
            <div class="p-6 border-b">
                <h3 class="text-xl font-bold text-gray-900">Confirmar Datos del Ticket</h3>
                <p class="text-sm text-gray-600">Revisa los datos extraídos por la IA. Si son correctos, guárdalos.</p>
            </div>
            <div id="confirmation-content" class="p-6 overflow-y-auto"></div>
            <div class="p-4 bg-gray-50 border-t flex justify-end gap-4">
                <button id="confirm-cancel-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button id="confirm-save-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Guardar Compra</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Confirmación para Borrado -->
    <div id="delete-confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full mx-auto">
            <h3 id="delete-modal-title" class="text-lg font-bold">Confirmar eliminación</h3>
            <p id="delete-modal-message" class="mt-2 text-sm text-gray-600"></p>
            <div class="mt-4 flex justify-end gap-4">
                <button id="delete-cancel-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button id="delete-confirm-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Bienvenida (Onboarding) -->
    <div id="welcome-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-auto text-center">
            <i class="fas fa-rocket fa-3x text-indigo-500 mb-4"></i>
            <h3 class="text-2xl font-bold">¡Bienvenido a tu Gestor de Gastos!</h3>
            <p class="mt-4 text-gray-600">Estamos encantados de tenerte aquí. Para empezar, simplemente ve a la pestaña <strong>"Analizar Ticket"</strong>, sube una foto de tu primer recibo, y deja que la magia de la IA haga el resto.</p>
            <p class="mt-2 text-gray-600">¡Feliz ahorro!</p>
            <div class="mt-6">
                <button id="welcome-close-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">¡Entendido!</button>
            </div>
        </div>
    </div>

    <!-- Modal de Actualización a Premium -->
    <div id="upgrade-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-auto">
            <div class="text-center">
                <i class="fas fa-star fa-3x text-yellow-500 mb-4"></i>
                <h3 class="text-2xl font-bold">Desbloquea todo el Potencial</h3>
            </div>
            <ul class="mt-4 space-y-2 text-gray-600">
                <li class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i> <strong>Análisis de Precios:</strong> Compara supermercados y sigue la evolución de los precios.</li>
                <li class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i> <strong>Presupuestos Inteligentes:</strong> Fija límites por categoría y recibe alertas.</li>
                <li class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i> <strong>Exportación de Datos:</strong> Descarga tus gastos en CSV o PDF.</li>
                <li class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i> <strong>Sin Anuncios:</strong> Disfruta de una experiencia limpia y sin interrupciones.</li>
            </ul>
            <div class="mt-6">
                <button class="w-full bg-yellow-500 text-white font-bold py-3 rounded-lg hover:bg-yellow-600">Suscribirse a Premium</button>
                <button id="upgrade-close-btn" class="w-full mt-2 text-sm text-gray-500 hover:underline">Quizás más tarde</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, writeBatch, deleteDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // --- PWA: Service Worker y Manifest ---
        const manifest = {
            "name": "Gestor de Gastos IA",
            "short_name": "Gastos IA",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#4f46e5",
            "description": "Tu asistente de ahorro inteligente.",
            "icons": [{
                "src": "https://placehold.co/192x192/4f46e5/ffffff?text=GASTO",
                "sizes": "192x192",
                "type": "image/png"
            }, {
                "src": "https://placehold.co/512x512/4f46e5/ffffff?text=GASTO-IA",
                "sizes": "512x512",
                "type": "image/png"
            }]
        };
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.querySelector('link[rel="manifest"]').setAttribute('href', manifestURL);
        document.querySelector('link[rel="apple-touch-icon"]').setAttribute('href', "https://placehold.co/192x192/4f46e5/ffffff?text=GASTO");

        const swContent = `
            self.addEventListener('install', (e) => {
                console.log('Service Worker: Installed');
            });
            self.addEventListener('fetch', (e) => {
                e.respondWith(
                    fetch(e.request).catch(() => caches.match(e.request))
                );
            });
        `;
        const swBlob = new Blob([swContent], { type: 'application/javascript' });
        const swURL = URL.createObjectURL(swBlob);

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register(swURL)
                    .then(registration => console.log('ServiceWorker registration successful'))
                    .catch(err => console.log('ServiceWorker registration failed: ', err));
            });
        }
        
        // --- CONFIGURACIÓN E INICIALIZACIÓN ---
        const firebaseConfig = {
          apiKey: "AIzaSyChOxUkl2C_4g7duYdFE0oUlQ9vpjLTJYQ",
          authDomain: "tickets-clasificator.firebaseapp.com",
          projectId: "tickets-clasificator",
          storageBucket: "tickets-clasificator.firebasestorage.app",
          messagingSenderId: "929759305226",
          appId: "1:929759305226:web:792b430618ae4a419a09f3",
          measurementId: "G-FW5ER1GV03"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        
        let userId = null;
        let allPurchases = [];
        let currentFilteredPurchases = [];
        let selectedPurchases = new Set();
        let supermarketChart = null;
        let categoryChart = null;
        let currentPurchaseData = null; 
        let currentFile = null;
        let userPlan = 'free';
        
        let categoryChartLevel = 1; // 1: Principal, 2: Familia, 3: Subfamilia
        let selectedPrincipal = null;
        let selectedFamilia = null;

        const categorias = {
            "🛒 ALIMENTOS Y BEBIDAS": {
                "🍓🥦 Frutas y Verduras": ["🥬 Verduras", "🥔 Tubérculos", "🍄 Setas y Hongos", "🍎 Frutas Frescas", "🍇 Frutas Deshidratadas"],
                "🥩🍗 Carnes y Aves": ["🐔 Aves", "🐄 Ternera", "🐖 Cerdo", "🐑 Cordero", "🌭 Embutidos"],
                "🐟🦐 Pescados y Mariscos": ["🐠 Pescado Fresco", "🦞 Marisco Fresco", "🧊 Pescado Congelado", "🥫 Conservas de Pescado"],
                "🥛🥚 Lácteos y Huevos": ["🥛 Leche", "🍮 Yogures y Postres Lácteos", "🧀 Quesos", "🥚 Huevos"],
                "🍞🥐 Panadería y Pastelería": ["🥖 Pan", "🍩 Bollería", "🍰 Pasteles", "🍪 Galletas"],
                "🌾🫘 Cereales y Legumbres": ["🍚 Arroz", "🍝 Pasta", "🥣 Legumbres Secas", "🥣 Cereales de Desayuno"],
                "🍾🍶 Aceites, Vinagres y Salsas": ["🫒 Aceites Comestibles", "🍇 Vinagres", "🥫 Salsas Preparadas", "🧂 Condimentos y Especias"],
                "🥫🥡 Conservas y Platos Preparados": ["🫙 Conservas Vegetales", "🥩 Conservas Cárnicas", "🍲 Platos Listos para Consumir"],
                "🧊 Congelados": ["🥦 Verduras Congeladas", "🐟 Pescado Congelado", "🍕 Comidas Preparadas Congeladas", "🍨 Helados"],
                "🥤 Bebidas": ["🧃 Bebidas No Alcohólicas", "🍺 Bebidas Alcohólicas"],
                "🥨🍬 Snacks y Dulces": ["🍟 Patatas Fritas y Aperitivos", "🍫 Chocolates y Golosinas", "🥜 Frutos Secos"],
                "❤️‍🩹 Dietéticos y Especiales": ["🚫🌾 Sin Gluten", "🚫🥛 Sin Lactosa", "🌱 Orgánicos/Biológicos", "🌿 Vegetarianos/Veganos"]
            },
            "🏠 HOGAR Y LIMPIEZA": {
                "🧼🧽 Productos de Limpieza": ["🧴 Limpiadores Multiusos", "🧺 Detergentes para Ropa", "🚽 Productos de Baño y Cocina", "🦟 Insecticidas"],
                "🍴🍽️ Menaje y Utensilios": ["🍷 Vajilla y Cristalería", "🍳 Batería de Cocina", "🔌 Pequeños Electrodomésticos"],
                "🏡 Cuidado del Hogar": ["🧻 Papel de Cocina y Servilletas", "🗑️ Bolsas de Basura", "🔋💡 Pilas y Bombillas", "🌬️ Ambientadores"]
            },
            "🧴 HIGIENE Y CUIDADO PERSONAL": {
                "🚿🧼 Higiene Diaria": ["🧴 Champú y Acondicionador", "🧼 Gel de Ducha y Jabón", "🦷 Pasta de Dientes y Cuidado Bucal", "💨 Desodorantes"],
                "💆‍♀️💅 Cuidado Facial y Corporal": ["🧴 Cremas y Lociones", "💄 Maquillaje", "☀️ Protector Solar"],
                "⚕️💊 Farmacia/Parafarmacia": ["💊 Medicamentos Sin Receta", "💪 Suplementos y Vitaminas", "🩹 Material de Primeros Auxilios"]
            },
            "🐾 MASCOTAS": {
                "🦴🍖 Alimento para Mascotas": ["🐶 Perros", "🐱 Gatos", "🐹 Otras Mascotas"],
                "🧸 Accesorios para Mascotas": ["🎾 Juguetes", "🧼 Productos de Higiene para Mascotas"]
            },
            "💸 OTROS GASTOS": {
                "🚗🚌 Transporte": ["⛽ Combustible", "🚇 Transporte Público", "🔧 Mantenimiento del Vehículo"],
                "🧾 Facturas y Servicios": ["💡 Electricidad", "💧 Agua", "🔥 Gas", "💻 Internet y Telefonía", "📺 Suscripciones"],
                "🎉🎭 Ocio y Entretenimiento": ["🍽️ Restaurantes y Bares", "🎬 Cine, Teatro y Conciertos", "⚽ Deportes y Actividades", "✈️ Viajes"],
                "🏡 Vivienda": ["🔑 Alquiler/Hipoteca", "🛠️ Mantenimiento y Reparaciones", "💰 Impuestos y Seguros de Hogar"],
                "💻📱 Tecnología": ["🖥️ Dispositivos Electrónicos", "💾 Software y Aplicaciones"],
                "💳💰 Finanzas": ["🏦 Comisiones Bancarias", "📄 Seguros", "📉 Intereses de Deuda"],
                "🎓📚 Educación y Formación": ["🧑‍🏫 Cursos y Talleres", "📖 Libros y Material Didáctico"],
                "👕👗 Vestimenta y Accesorios": ["👕 Ropa", "👟 Calzado", "👜 Accesorios"],
                "❤️‍🩹🩺 Salud": ["🧑‍⚕️ Consultas Médicas", "℞ Medicamentos con Receta"]
            }
        };

        const chartColors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
            '#F06292', '#4FC3F7', '#FFEE58', '#80CBC4', '#B39DDB', '#FFB74D',
            '#E57373', '#64B5F6', '#FFF176', '#4DB6AC', '#CE93D8', '#FFD54F',
            '#D32F2F', '#1976D2', '#FBC02D', '#00796B', '#7B1FA2', '#F57C00'
        ];

        const cleanLabel = (label) => label.replace(/^\d+(\.\d+)*\.\s*/, '');

        // --- MANEJO DE AUTENTICACIÓN Y VISIBILIDAD DE PÁGINA ---
        const landingPage = document.getElementById('landing-page');
        const appContainer = document.getElementById('app-container');
        const landingLoginBtn = document.getElementById('landing-login-btn');
        const landingRegisterBtn = document.getElementById('landing-register-btn');
        const finalCtaBtn = document.getElementById('final-cta-btn');
        const authContainer = document.getElementById('auth-container');

        const handleLogin = () => {
            signInWithPopup(auth, provider)
                .catch((error) => {
                    if (error.code === 'auth/unauthorized-domain') {
                        showMessage(
                            "Error de Configuración de Firebase", 
                            "El dominio actual no está autorizado. Para solucionarlo, ve a tu proyecto de Firebase -> Authentication -> Sign-in method -> Google y añade el dominio desde el que ejecutas la app a la lista de 'Dominios autorizados'."
                        );
                    } else {
                        console.error("Error al iniciar sesión con Google:", error);
                        showMessage("Error de Autenticación", `No se pudo iniciar sesión con Google. Error: ${error.message}`);
                    }
                });
        };

        landingLoginBtn.addEventListener('click', handleLogin);
        landingRegisterBtn.addEventListener('click', handleLogin);
        finalCtaBtn.addEventListener('click', handleLogin);

        const handleSignOut = () => {
            signOut(auth).catch((error) => {
                console.error("Error al cerrar sesión:", error);
                showMessage("Error", "No se pudo cerrar la sesión.");
            });
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                landingPage.classList.add('hidden');
                appContainer.classList.remove('hidden');
                authContainer.innerHTML = `
                    <div class="flex items-center gap-4 cursor-pointer" id="user-profile-button">
                        <img src="${user.photoURL}" alt="${user.displayName}" class="w-10 h-10 rounded-full">
                        <div>
                            <p class="font-semibold">${user.displayName}</p>
                        </div>
                    </div>
                    <div id="user-menu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg py-1 z-50 transform -translate-x-full">
                        <div class="px-4 py-2 text-sm text-gray-700">
                            <p class="font-bold">Tu ID de Usuario:</p>
                            <p class="text-xs text-gray-500 break-all" id="user-id-display">${user.uid}</p>
                            <button id="copy-user-id" class="text-indigo-600 text-xs mt-1">Copiar</button>
                        </div>
                        <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-red-500 hover:bg-gray-100">Cerrar sesión</a>
                    </div>
                `;
                document.getElementById('logout-btn').addEventListener('click', handleSignOut);
                document.getElementById('user-profile-button').addEventListener('click', () => {
                    document.getElementById('user-menu').classList.toggle('hidden');
                });
                document.getElementById('copy-user-id').addEventListener('click', () => {
                    navigator.clipboard.writeText(userId);
                    showMessage("Copiado", "Tu ID de usuario ha sido copiado al portapapeles.");
                });
                
                checkUserPlan();
                loadInitialData();
            } else {
                userId = null;
                landingPage.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        });
        
        // ... (el resto de las funciones JS van aquí, completas)
    </script>
</body>
</html>

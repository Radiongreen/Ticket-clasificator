<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Gastos IA</title>
    
    <!-- Meta tags para PWA -->
    <meta name="theme-color" content="#4f46e5"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/icon-192x192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-button { padding: 1rem; border-bottom: 3px solid transparent; transition: all 0.3s ease; cursor: pointer; }
        .tab-button.active { border-color: #4f46e5; color: #4f46e5; background-color: #eef2ff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .loader { border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid #4f46e5; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { transition: opacity 0.3s ease; }
        #app-content.hidden, #login-container.hidden { display: none; }
        .table-actions button:disabled { background-color: #d1d5db; cursor: not-allowed; }
        .achievement.unlocked { opacity: 1; }
        .achievement.locked { opacity: 0.4; filter: grayscale(100%); }
        .premium-feature { position: relative; border: 2px dashed #d1d5db; padding: 2rem; border-radius: 0.5rem; margin-top: 1rem; }
        .premium-overlay { position: absolute; inset: 0; background-color: rgba(249, 250, 251, 0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; border-radius: 0.5rem; cursor: pointer; }
        #ads-banner.hidden { display: none; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Contenedor principal de la aplicaci√≥n -->
    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Gestor de Gastos IA v2.0</h1>
                <p class="text-gray-600 mt-1">Tu asistente de ahorro inteligente.</p>
            </div>
            <div id="auth-container"></div>
        </header>

        <!-- Contenedor de Login -->
        <div id="login-container" class="text-center py-16">
            <h2 class="text-2xl font-bold mb-4">Bienvenido a tu Gestor de Gastos</h2>
            <p class="text-gray-600 mb-8">Inicia sesi√≥n con tu cuenta de Google para guardar y acceder a tus datos de forma segura.</p>
            <button id="login-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                <i class="fab fa-google mr-2"></i> Iniciar sesi√≥n con Google
            </button>
            <p class="text-xs text-gray-500 mt-4"><i class="fas fa-shield-alt mr-1"></i>Tus datos est√°n protegidos con cifrado a nivel bancario.</p>
        </div>
        
        <!-- Contenido principal de la App (oculto hasta login) -->
        <div id="app-content" class="hidden">
            <!-- Navegaci√≥n por pesta√±as -->
            <div class="mb-8 border-b border-gray-200">
                <nav class="flex flex-wrap -mb-px" aria-label="Tabs">
                    <button class="tab-button active" data-tab="analizar-ticket"><i class="fas fa-receipt mr-2"></i> Analizar Ticket</button>
                    <button class="tab-button" data-tab="mis-gastos"><i class="fas fa-chart-pie mr-2"></i> Mis Gastos</button>
                    <button class="tab-button" data-tab="mis-productos"><i class="fas fa-tag mr-2"></i> Mis Productos</button>
                    <button class="tab-button" data-tab="lista-compra"><i class="fas fa-list-check mr-2"></i> Lista de Compra</button>
                    <button class="tab-button" data-tab="logros"><i class="fas fa-trophy mr-2"></i> Mis Logros</button>
                    <button class="tab-button" data-tab="premium"><i class="fas fa-star mr-2"></i> Premium</button>
                </nav>
            </div>

            <!-- Contenido de las pesta√±as -->
            <main>
                <!-- Pesta√±a: Analizar Ticket -->
                <div id="analizar-ticket" class="tab-content active">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h2 class="text-xl font-semibold mb-4">1. Sube tu Ticket</h2>
                            <div id="image-uploader" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                                <div class="space-y-1 text-center">
                                    <i class="fas fa-camera fa-3x text-gray-400"></i>
                                    <div class="flex text-sm text-gray-600">
                                        <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                                            <span>Sube un archivo</span>
                                            <input id="file-upload" name="file-upload" type="file" class="sr-only" accept="image/*">
                                        </label>
                                        <p class="pl-1">o arr√°stralo aqu√≠</p>
                                    </div>
                                    <p class="text-xs text-gray-500">PNG, JPG, GIF hasta 10MB</p>
                                </div>
                            </div>
                            <button id="process-ticket-btn" class="mt-6 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 disabled:bg-gray-400" disabled>
                                <i class="fas fa-cogs mr-2"></i> Procesar Ticket
                            </button>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h2 class="text-xl font-semibold mb-4">2. Vista Previa</h2>
                            <div id="image-preview-container" class="w-full h-64 bg-gray-100 rounded-lg flex items-center justify-center text-gray-500">
                                <p>Aqu√≠ ver√°s la imagen de tu ticket.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pesta√±a: Mis Gastos -->
                <div id="mis-gastos" class="tab-content">
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-8">
                        <h2 class="text-xl font-semibold mb-4">Filtros</h2>
                        <div class="flex flex-wrap gap-4">
                            <select id="filter-year" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full md:w-auto p-2.5"></select>
                            <select id="filter-month" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full md:w-auto p-2.5"></select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 flex flex-col justify-center items-center">
                            <h3 class="text-lg font-semibold mb-2">Gasto Total</h3>
                            <p id="total-expense" class="text-3xl font-bold text-indigo-600">0,00 ‚Ç¨</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 flex flex-col justify-center items-center">
                            <h3 class="text-lg font-semibold mb-2">N¬∫ de Compras</h3>
                            <p id="total-purchases" class="text-3xl font-bold text-indigo-600">0</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold mb-4 text-center">Gasto por Supermercado</h3>
                            <div class="h-64 md:h-80"><canvas id="supermarket-chart"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <div class="flex justify-between items-center mb-4">
                                <h3 id="category-chart-title" class="text-lg font-semibold">Gasto por Categor√≠a Principal</h3>
                                <button id="category-chart-back-btn" class="hidden text-sm text-indigo-600 hover:underline"><i class="fas fa-arrow-left mr-1"></i> Volver</button>
                            </div>
                            <div class="h-64 md:h-80"><canvas id="category-chart"></canvas></div>
                        </div>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Historial de Compras</h3>
                            <div class="table-actions">
                                <button id="delete-selected-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300" disabled>
                                    <i class="fas fa-trash mr-2"></i>Eliminar seleccionados
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th scope="col" class="p-4">
                                            <input type="checkbox" id="select-all-checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                                        </th>
                                        <th scope="col" class="px-6 py-3">Fecha</th>
                                        <th scope="col" class="px-6 py-3">Supermercado</th>
                                        <th scope="col" class="px-6 py-3">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="purchases-history"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="ads-banner" class="hidden mt-8 p-4 bg-gray-200 rounded-lg text-center text-gray-600">
                        <p class="text-sm">Espacio para publicidad (Visible solo para usuarios gratuitos)</p>
                        <!-- Aqu√≠ se pegar√≠a el c√≥digo de Google AdSense -->
                    </div>
                </div>

                <!-- Pesta√±a: Mis Productos -->
                <div id="mis-productos" class="tab-content">
                     <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <h2 class="text-xl font-semibold mb-4">Gesti√≥n de Productos</h2>
                        <p class="text-sm text-gray-600 mb-4">Aqu√≠ puedes ver todos los productos √∫nicos que has comprado y corregir su categorizaci√≥n si es necesario. Los cambios se aplicar√°n a todas las compras pasadas.</p>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">Producto</th>
                                        <th scope="col" class="px-6 py-3">Categor√≠a Principal</th>
                                        <th scope="col" class="px-6 py-3">Familia</th>
                                        <th scope="col" class="px-6 py-3">Subfamilia</th>
                                        <th scope="col" class="px-6 py-3">N¬∫ Compras</th>
                                        <th scope="col" class="px-6 py-3">Tendencia de Precio</th>
                                    </tr>
                                </thead>
                                <tbody id="products-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Pesta√±a: Lista de la Compra -->
                <div id="lista-compra" class="tab-content">
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <h2 class="text-xl font-semibold mb-4">Lista de la Compra Inteligente</h2>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="add-item-input" placeholder="A√±adir producto..." class="flex-grow bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5">
                            <button id="add-item-btn" class="bg-indigo-600 text-white px-4 rounded-lg"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="shopping-list" class="space-y-2 mb-6">
                            <!-- Los productos de la lista se a√±adir√°n aqu√≠ -->
                        </div>
                        <div class="border-t pt-4">
                             <h3 class="font-semibold mb-2">Sugerencias de la IA</h3>
                             <p class="text-sm text-gray-600 mb-4">Basado en tu historial, puede que necesites comprar esto:</p>
                             <button id="suggest-items-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                                <i class="fas fa-wand-magic-sparkles mr-2"></i>Sugerir Productos
                             </button>
                             <div id="suggestions-container" class="mt-4 space-y-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Pesta√±a: Mis Logros -->
                <div id="logros" class="tab-content">
                     <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <h2 class="text-xl font-semibold mb-4">Mis Logros</h2>
                        <div id="achievements-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 text-center mb-8">
                            <!-- Los logros se generar√°n aqu√≠ -->
                        </div>
                        <h2 class="text-xl font-semibold mb-4 border-t pt-6">Reto Semanal</h2>
                        <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-bullseye fa-2x text-blue-500 mr-4"></i>
                                <div>
                                    <h3 class="font-bold">Gasta un 10% menos en "Snacks"</h3>
                                    <p class="text-sm text-gray-600">¬°Acepta el reto y mejora tus h√°bitos de ahorro!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pesta√±a: Premium -->
                <div id="premium" class="tab-content">
                     <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <h2 class="text-xl font-semibold mb-4">Funciones Premium</h2>
                        
                        <div class="premium-feature">
                            <h3 class="text-lg font-semibold mb-2">M√≥dulo Avanzado de An√°lisis de Precios</h3>
                            <p class="text-gray-600">Gr√°ficos de evoluci√≥n, comparador de supermercados y alertas de ofertas.</p>
                            <div class="premium-overlay">
                                <i class="fas fa-lock fa-2x text-yellow-500 mb-2"></i>
                                <p class="font-semibold">Funci√≥n Premium</p>
                                <button class="mt-4 bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg upgrade-btn">¬°Actualiza ahora!</button>
                            </div>
                        </div>

                        <div class="premium-feature">
                            <h3 class="text-lg font-semibold mb-2">M√≥dulo de Presupuestos Inteligentes</h3>
                            <p class="text-gray-600">Define l√≠mites por categor√≠a, recibe alertas en tiempo real y obt√©n recomendaciones de ahorro.</p>
                             <div class="premium-overlay">
                                <i class="fas fa-lock fa-2x text-yellow-500 mb-2"></i>
                                <p class="font-semibold">Funci√≥n Premium</p>
                                <button class="mt-4 bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg upgrade-btn">¬°Actualiza ahora!</button>
                            </div>
                        </div>
                     </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Overlay de procesamiento -->
    <div id="processing-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-lg font-medium">Procesando...</p>
        </div>
    </div>

    <!-- Modal para mostrar mensajes gen√©ricos -->
    <div id="message-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full mx-auto">
            <h3 id="modal-title" class="text-lg font-bold"></h3>
            <p id="modal-message" class="mt-2 text-sm text-gray-600"></p>
            <div class="mt-4 text-right">
                <button id="modal-close-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n de Ticket -->
    <div id="confirmation-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-auto max-h-[90vh] flex flex-col">
            <div class="p-6 border-b">
                <h3 class="text-xl font-bold text-gray-900">Confirmar Datos del Ticket</h3>
                <p class="text-sm text-gray-600">Revisa los datos extra√≠dos por la IA. Si son correctos, gu√°rdalos.</p>
            </div>
            <div id="confirmation-content" class="p-6 overflow-y-auto"></div>
            <div class="p-4 bg-gray-50 border-t flex justify-end gap-4">
                <button id="confirm-cancel-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button id="confirm-save-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Guardar Compra</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Confirmaci√≥n para Borrado -->
    <div id="delete-confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full mx-auto">
            <h3 id="delete-modal-title" class="text-lg font-bold">Confirmar eliminaci√≥n</h3>
            <p id="delete-modal-message" class="mt-2 text-sm text-gray-600"></p>
            <div class="mt-4 flex justify-end gap-4">
                <button id="delete-cancel-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button id="delete-confirm-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Bienvenida (Onboarding) -->
    <div id="welcome-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-auto text-center">
            <i class="fas fa-rocket fa-3x text-indigo-500 mb-4"></i>
            <h3 class="text-2xl font-bold">¬°Bienvenido a tu Gestor de Gastos!</h3>
            <p class="mt-4 text-gray-600">Estamos encantados de tenerte aqu√≠. Para empezar, simplemente ve a la pesta√±a <strong>"Analizar Ticket"</strong>, sube una foto de tu primer recibo, y deja que la magia de la IA haga el resto.</p>
            <p class="mt-2 text-gray-600">¬°Feliz ahorro!</p>
            <div class="mt-6">
                <button id="welcome-close-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">¬°Entendido!</button>
            </div>
        </div>
    </div>

    <!-- Modal de Actualizaci√≥n a Premium -->
    <div id="upgrade-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-auto">
            <div class="text-center">
                <i class="fas fa-star fa-3x text-yellow-500 mb-4"></i>
                <h3 class="text-2xl font-bold">Desbloquea todo el Potencial</h3>
            </div>
            <ul class="mt-4 space-y-2 text-gray-600">
                <li class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i> <strong>An√°lisis de Precios:</strong> Compara supermercados y sigue la evoluci√≥n de los precios.</li>
                <li class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i> <strong>Presupuestos Inteligentes:</strong> Fija l√≠mites por categor√≠a y recibe alertas.</li>
                <li class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i> <strong>Exportaci√≥n de Datos:</strong> Descarga tus gastos en CSV o PDF.</li>
                <li class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i> <strong>Sin Anuncios:</strong> Disfruta de una experiencia limpia y sin interrupciones.</li>
            </ul>
            <div class="mt-6">
                <button class="w-full bg-yellow-500 text-white font-bold py-3 rounded-lg hover:bg-yellow-600">Suscribirse a Premium</button>
                <button id="upgrade-close-btn" class="w-full mt-2 text-sm text-gray-500 hover:underline">Quiz√°s m√°s tarde</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, writeBatch, deleteDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // --- PWA: Service Worker y Manifest ---
        const manifest = {
            "name": "Gestor de Gastos IA",
            "short_name": "Gastos IA",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#4f46e5",
            "description": "Tu asistente de ahorro inteligente.",
            "icons": [{
                "src": "https://placehold.co/192x192/4f46e5/ffffff?text=GASTO",
                "sizes": "192x192",
                "type": "image/png"
            }, {
                "src": "https://placehold.co/512x512/4f46e5/ffffff?text=GASTO-IA",
                "sizes": "512x512",
                "type": "image/png"
            }]
        };
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.querySelector('link[rel="manifest"]').setAttribute('href', manifestURL);
        document.querySelector('link[rel="apple-touch-icon"]').setAttribute('href', "https://placehold.co/192x192/4f46e5/ffffff?text=GASTO");

        const swContent = `
            self.addEventListener('install', (e) => {
                console.log('Service Worker: Installed');
            });
            self.addEventListener('fetch', (e) => {
                e.respondWith(
                    fetch(e.request).catch(() => caches.match(e.request))
                );
            });
        `;
        const swBlob = new Blob([swContent], { type: 'application/javascript' });
        const swURL = URL.createObjectURL(swBlob);

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register(swURL)
                    .then(registration => console.log('ServiceWorker registration successful'))
                    .catch(err => console.log('ServiceWorker registration failed: ', err));
            });
        }
        
        // --- CONFIGURACI√ìN E INICIALIZACI√ìN ---
        const firebaseConfig = {
          apiKey: "AIzaSyChOxUkl2C_4g7duYdFE0oUlQ9vpjLTJYQ",
          authDomain: "tickets-clasificator.firebaseapp.com",
          projectId: "tickets-clasificator",
          storageBucket: "tickets-clasificator.firebasestorage.app",
          messagingSenderId: "929759305226",
          appId: "1:929759305226:web:792b430618ae4a419a09f3",
          measurementId: "G-FW5ER1GV03"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        
        let userId = null;
        let allPurchases = [];
        let currentFilteredPurchases = [];
        let selectedPurchases = new Set();
        let supermarketChart = null;
        let categoryChart = null;
        let currentPurchaseData = null; 
        let currentFile = null;
        let userPlan = 'free';
        
        let categoryChartLevel = 1; // 1: Principal, 2: Familia, 3: Subfamilia
        let selectedPrincipal = null;
        let selectedFamilia = null;

        const categorias = {
            "üõí ALIMENTOS Y BEBIDAS": {
                "üçìü•¶ Frutas y Verduras": ["ü•¨ Verduras", "ü•î Tub√©rculos", "üçÑ Setas y Hongos", "üçé Frutas Frescas", "üçá Frutas Deshidratadas"],
                "ü•©üçó Carnes y Aves": ["üêî Aves", "üêÑ Ternera", "üêñ Cerdo", "üêë Cordero", "üå≠ Embutidos"],
                "üêüü¶ê Pescados y Mariscos": ["üê† Pescado Fresco", "ü¶û Marisco Fresco", "üßä Pescado Congelado", "ü•´ Conservas de Pescado"],
                "ü•õü•ö L√°cteos y Huevos": ["ü•õ Leche", "üçÆ Yogures y Postres L√°cteos", "üßÄ Quesos", "ü•ö Huevos"],
                "üçûü•ê Panader√≠a y Pasteler√≠a": ["ü•ñ Pan", "üç© Boller√≠a", "üç∞ Pasteles", "üç™ Galletas"],
                "üåæü´ò Cereales y Legumbres": ["üçö Arroz", "üçù Pasta", "ü•£ Legumbres Secas", "ü•£ Cereales de Desayuno"],
                "üçæüç∂ Aceites, Vinagres y Salsas": ["ü´í Aceites Comestibles", "üçá Vinagres", "ü•´ Salsas Preparadas", "üßÇ Condimentos y Especias"],
                "ü•´ü•° Conservas y Platos Preparados": ["ü´ô Conservas Vegetales", "ü•© Conservas C√°rnicas", "üç≤ Platos Listos para Consumir"],
                "üßä Congelados": ["ü•¶ Verduras Congeladas", "üêü Pescado Congelado", "üçï Comidas Preparadas Congeladas", "üç® Helados"],
                "ü•§ Bebidas": ["üßÉ Bebidas No Alcoh√≥licas", "üç∫ Bebidas Alcoh√≥licas"],
                "ü•®üç¨ Snacks y Dulces": ["üçü Patatas Fritas y Aperitivos", "üç´ Chocolates y Golosinas", "ü•ú Frutos Secos"],
                "‚ù§Ô∏è‚Äçü©π Diet√©ticos y Especiales": ["üö´üåæ Sin Gluten", "üö´ü•õ Sin Lactosa", "üå± Org√°nicos/Biol√≥gicos", "üåø Vegetarianos/Veganos"]
            },
            "üè† HOGAR Y LIMPIEZA": {
                "üßºüßΩ Productos de Limpieza": ["üß¥ Limpiadores Multiusos", "üß∫ Detergentes para Ropa", "üöΩ Productos de Ba√±o y Cocina", "ü¶ü Insecticidas"],
                "üç¥üçΩÔ∏è Menaje y Utensilios": ["üç∑ Vajilla y Cristaler√≠a", "üç≥ Bater√≠a de Cocina", "üîå Peque√±os Electrodom√©sticos"],
                "üè° Cuidado del Hogar": ["üßª Papel de Cocina y Servilletas", "üóëÔ∏è Bolsas de Basura", "üîãüí° Pilas y Bombillas", "üå¨Ô∏è Ambientadores"]
            },
            "üß¥ HIGIENE Y CUIDADO PERSONAL": {
                "üöøüßº Higiene Diaria": ["üß¥ Champ√∫ y Acondicionador", "üßº Gel de Ducha y Jab√≥n", "ü¶∑ Pasta de Dientes y Cuidado Bucal", "üí® Desodorantes"],
                "üíÜ‚Äç‚ôÄÔ∏èüíÖ Cuidado Facial y Corporal": ["üß¥ Cremas y Lociones", "üíÑ Maquillaje", "‚òÄÔ∏è Protector Solar"],
                "‚öïÔ∏èüíä Farmacia/Parafarmacia": ["üíä Medicamentos Sin Receta", "üí™ Suplementos y Vitaminas", "ü©π Material de Primeros Auxilios"]
            },
            "üêæ MASCOTAS": {
                "ü¶¥üçñ Alimento para Mascotas": ["üê∂ Perros", "üê± Gatos", "üêπ Otras Mascotas"],
                "üß∏ Accesorios para Mascotas": ["üéæ Juguetes", "üßº Productos de Higiene para Mascotas"]
            },
            "üí∏ OTROS GASTOS": {
                "üöóüöå Transporte": ["‚õΩ Combustible", "üöá Transporte P√∫blico", "üîß Mantenimiento del Veh√≠culo"],
                "üßæ Facturas y Servicios": ["üí° Electricidad", "üíß Agua", "üî• Gas", "üíª Internet y Telefon√≠a", "üì∫ Suscripciones"],
                "üéâüé≠ Ocio y Entretenimiento": ["üçΩÔ∏è Restaurantes y Bares", "üé¨ Cine, Teatro y Conciertos", "‚öΩ Deportes y Actividades", "‚úàÔ∏è Viajes"],
                "üè° Vivienda": ["üîë Alquiler/Hipoteca", "üõ†Ô∏è Mantenimiento y Reparaciones", "üí∞ Impuestos y Seguros de Hogar"],
                "üíªüì± Tecnolog√≠a": ["üñ•Ô∏è Dispositivos Electr√≥nicos", "üíæ Software y Aplicaciones"],
                "üí≥üí∞ Finanzas": ["üè¶ Comisiones Bancarias", "üìÑ Seguros", "üìâ Intereses de Deuda"],
                "üéìüìö Educaci√≥n y Formaci√≥n": ["üßë‚Äçüè´ Cursos y Talleres", "üìñ Libros y Material Did√°ctico"],
                "üëïüëó Vestimenta y Accesorios": ["üëï Ropa", "üëü Calzado", "üëú Accesorios"],
                "‚ù§Ô∏è‚Äçü©πü©∫ Salud": ["üßë‚Äç‚öïÔ∏è Consultas M√©dicas", "‚Ñû Medicamentos con Receta"]
            }
        };

        const chartColors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
            '#F06292', '#4FC3F7', '#FFEE58', '#80CBC4', '#B39DDB', '#FFB74D',
            '#E57373', '#64B5F6', '#FFF176', '#4DB6AC', '#CE93D8', '#FFD54F',
            '#D32F2F', '#1976D2', '#FBC02D', '#00796B', '#7B1FA2', '#F57C00'
        ];

        const cleanLabel = (label) => label.replace(/^\d+(\.\d+)*\.\s*/, '');

        // --- MANEJO DE AUTENTICACI√ìN ---
        const loginContainer = document.getElementById('login-container');
        const appContent = document.getElementById('app-content');
        const authContainer = document.getElementById('auth-container');
        const loginBtn = document.getElementById('login-btn');

        loginBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider)
                .catch((error) => {
                    if (error.code === 'auth/unauthorized-domain') {
                        showMessage(
                            "Error de Configuraci√≥n de Firebase", 
                            "El dominio actual no est√° autorizado. Para solucionarlo, ve a tu proyecto de Firebase -> Authentication -> Sign-in method -> Google y a√±ade el dominio desde el que ejecutas la app a la lista de 'Dominios autorizados'."
                        );
                    } else {
                        console.error("Error al iniciar sesi√≥n con Google:", error);
                        showMessage("Error de Autenticaci√≥n", `No se pudo iniciar sesi√≥n con Google. Error: ${error.message}`);
                    }
                });
        });

        const handleSignOut = () => {
            signOut(auth).catch((error) => {
                console.error("Error al cerrar sesi√≥n:", error);
                showMessage("Error", "No se pudo cerrar la sesi√≥n.");
            });
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                loginContainer.classList.add('hidden');
                appContent.classList.remove('hidden');
                authContainer.innerHTML = `
                    <div class="flex items-center gap-4">
                        <img src="${user.photoURL}" alt="${user.displayName}" class="w-10 h-10 rounded-full">
                        <div>
                            <p class="font-semibold">${user.displayName}</p>
                            <button id="logout-btn" class="text-sm text-red-500 hover:underline">Cerrar sesi√≥n</button>
                        </div>
                    </div>
                `;
                document.getElementById('logout-btn').addEventListener('click', handleSignOut);
                checkUserPlan();
                loadInitialData();
            } else {
                userId = null;
                loginContainer.classList.remove('hidden');
                appContent.classList.add('hidden');
                authContainer.innerHTML = '';
                allPurchases = [];
                renderDashboard();
            }
        });

        async function checkUserPlan() {
            if (!userId) return;
            const userDocRef = doc(db, `users/${userId}`);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) {
                userPlan = userDoc.data().plan || 'free';
                if(!userDoc.data().hasSeenWelcome) {
                    showWelcomeModal();
                    await setDoc(userDocRef, { hasSeenWelcome: true }, { merge: true });
                }
            } else {
                await setDoc(userDocRef, { plan: 'free', createdAt: new Date(), hasSeenWelcome: true }, { merge: true });
                userPlan = 'free';
                showWelcomeModal();
            }
            updateUIForPlan();
        }

        function updateUIForPlan() {
            const premiumOverlays = document.querySelectorAll('.premium-overlay');
            const adsBanner = document.getElementById('ads-banner');
            if (userPlan === 'premium') {
                premiumOverlays.forEach(el => el.classList.add('hidden'));
                adsBanner.classList.add('hidden');
            } else {
                 premiumOverlays.forEach(el => el.classList.remove('hidden'));
                 adsBanner.classList.remove('hidden');
            }
        }
        
        // --- NAVEGACI√ìN POR PESTA√ëAS ---
        const tabs = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(item => item.classList.remove('active'));
                tab.classList.add('active');
                const target = tab.getAttribute('data-tab');
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === target) {
                        content.classList.add('active');
                    }
                });
            });
        });
        
        // --- L√ìGICA DE LA PESTA√ëA "ANALIZAR TICKET" ---
        const fileUpload = document.getElementById('file-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const processBtn = document.getElementById('process-ticket-btn');
        const processingOverlay = document.getElementById('processing-overlay');
        let fileBase64 = null;

        fileUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                currentFile = file;
                const reader = new FileReader();
                reader.onload = (event) => {
                    fileBase64 = event.target.result.split(',')[1];
                    imagePreviewContainer.innerHTML = `<img src="${event.target.result}" alt="Vista previa del ticket" class="max-h-full max-w-full object-contain rounded-lg">`;
                    processBtn.disabled = false;
                };
                reader.readAsDataURL(file);
            }
        });

        processBtn.addEventListener('click', async () => {
            if (!fileBase64) {
                showMessage("Error", "Por favor, sube una imagen primero.");
                return;
            }
            processingOverlay.querySelector('p').textContent = "Analizando ticket con IA...";
            processingOverlay.classList.remove('hidden');
            try {
                const result = await analyzeTicketWithAI(fileBase64);
                currentPurchaseData = result;
                displayPurchaseConfirmation(result);
            } catch (error) {
                console.error("Error procesando el ticket:", error);
                showMessage("Error de IA", `No se pudo analizar el ticket. Detalles: ${error.message}`);
            } finally {
                processingOverlay.classList.add('hidden');
            }
        });

        async function analyzeTicketWithAI(base64ImageData) {
            const apiKey = "AIzaSyCBek1Vt1x3h-fqPr1Vx2OWk_a1kICpi0c";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const prompt = `Analiza la imagen de este ticket de compra. Extrae la informaci√≥n y devu√©lvela ESTRICTAMENTE en formato JSON. Para cada item, extrae: { "producto": "nombre exacto", "cantidad": numero, "precio_unitario": numero, "categoria_principal": "...", "familia": "...", "subfamilia": "..." }. Usa la siguiente jerarqu√≠a de categor√≠as ESTRICTAMENTE. Asigna el nivel m√°s espec√≠fico posible. Si no encaja, usa una categor√≠a general. Jerarqu√≠a permitida: ${JSON.stringify(categorias)}`;
            
            const payload = { 
                contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64ImageData } }] }], 
                generationConfig: { 
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "supermercado": { "type": "STRING" },
                            "fecha": { "type": "STRING", "description": "Fecha en formato YYYY-MM-DD" },
                            "total": { "type": "NUMBER" },
                            "items": {
                                "type": "ARRAY",
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "producto": { "type": "STRING" },
                                        "cantidad": { "type": "NUMBER" },
                                        "precio_unitario": { "type": "NUMBER" },
                                        "categoria_principal": { "type": "STRING" },
                                        "familia": { "type": "STRING" },
                                        "subfamilia": { "type": "STRING" }
                                    },
                                    "required": ["producto", "cantidad", "precio_unitario", "categoria_principal", "familia", "subfamilia"]
                                }
                            }
                        },
                         "required": ["supermercado", "fecha", "total", "items"]
                    }
                } 
            };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`Error en la API de Gemini: ${response.status} ${await response.text()}`);
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                return JSON.parse(result.candidates[0].content.parts[0].text);
            } else {
                throw new Error("La respuesta de la IA no tiene el formato esperado o est√° vac√≠a.");
            }
        }
        
        // --- L√ìGICA DE GAMIFICACI√ìN ---
        const achievements = {
            firstScan: { title: "Primer Escaneo", icon: "fa-camera", unlocked: false, description: "Analiza tu primer ticket." },
            fiveScans: { title: "Coleccionista", icon: "fa-receipt", unlocked: false, description: "Analiza 5 tickets." },
        };

        function checkAchievements() {
            if (allPurchases.length >= 1) achievements.firstScan.unlocked = true;
            if (allPurchases.length >= 5) achievements.fiveScans.unlocked = true;
            renderAchievements();
        }

        function renderAchievements() {
            const grid = document.getElementById('achievements-grid');
            if(!grid) return;
            grid.innerHTML = '';
            for (const key in achievements) {
                const achievement = achievements[key];
                const element = document.createElement('div');
                element.className = `achievement p-4 rounded-lg ${achievement.unlocked ? 'unlocked bg-green-100' : 'locked bg-gray-200'}`;
                element.innerHTML = `
                    <i class="fas ${achievement.icon} fa-3x ${achievement.unlocked ? 'text-green-500' : 'text-gray-400'}"></i>
                    <p class="font-semibold mt-2">${achievement.title}</p>
                    <p class="text-xs text-gray-600">${achievement.description}</p>
                `;
                grid.appendChild(element);
            }
        }
        
        function loadInitialData() {
            if (!userId) return;
            const purchasesCol = collection(db, `users/${userId}/compras`);
            onSnapshot(purchasesCol, (snapshot) => {
                allPurchases = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                selectedPurchases.clear();
                updateDeleteButtonState();
                populateFilters();
                renderDashboard();
                renderProductsTab();
                checkAchievements();
            });
        }
        
        // --- L√ìGICA DE LISTA DE COMPRA ---
        const addItemInput = document.getElementById('add-item-input');
        const addItemBtn = document.getElementById('add-item-btn');
        const shoppingListContainer = document.getElementById('shopping-list');
        const suggestItemsBtn = document.getElementById('suggest-items-btn');
        const suggestionsContainer = document.getElementById('suggestions-container');

        if(addItemBtn) {
            addItemBtn.addEventListener('click', () => {
                const itemName = addItemInput.value.trim();
                if (itemName) {
                    addShoppingListItem(itemName);
                    addItemInput.value = '';
                }
            });
        }
        
        function addShoppingListItem(name) {
            const itemEl = document.createElement('div');
            itemEl.className = 'flex items-center justify-between bg-gray-100 p-2 rounded';
            itemEl.innerHTML = `
                <span>${name}</span>
                <button class="text-red-500 remove-item-btn"><i class="fas fa-times"></i></button>
            `;
            itemEl.querySelector('.remove-item-btn').addEventListener('click', () => itemEl.remove());
            shoppingListContainer.appendChild(itemEl);
        }

        if(suggestItemsBtn) {
            suggestItemsBtn.addEventListener('click', async () => {
                processingOverlay.querySelector('p').textContent = "Generando sugerencias...";
                processingOverlay.classList.remove('hidden');
                try {
                    const purchaseHistory = allPurchases.flatMap(p => p.items.map(item => item.producto)).join(', ');
                    if (!purchaseHistory) {
                        showMessage("Informaci√≥n", "No hay suficiente historial para generar sugerencias.");
                        processingOverlay.classList.add('hidden');
                        return;
                    }
                    const prompt = `Basado en esta lista de productos comprados anteriormente, sugiere 5 productos que el usuario podr√≠a necesitar comprar. Devuelve solo una lista de nombres de productos en formato JSON array, por ejemplo: ["Leche", "Pan de molde"]. Historial: ${purchaseHistory}`;
                    
                    const apiKey = "AIzaSyCBek1Vt1x3h-fqPr1Vx2OWk_a1kICpi0c";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" }};
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error('Error en la API de Gemini');
                    
                    const result = await response.json();
                    const suggestions = JSON.parse(result.candidates[0].content.parts[0].text);
                    
                    suggestionsContainer.innerHTML = '';
                    suggestions.forEach(item => {
                        const suggestionEl = document.createElement('div');
                        suggestionEl.className = 'flex items-center justify-between bg-green-100 p-2 rounded';
                        suggestionEl.innerHTML = `
                            <span>${item}</span>
                            <button class="text-green-700 add-suggestion-btn"><i class="fas fa-plus"></i> A√±adir</button>
                        `;
                        suggestionEl.querySelector('.add-suggestion-btn').addEventListener('click', () => {
                            addShoppingListItem(item);
                            suggestionEl.remove();
                        });
                        suggestionsContainer.appendChild(suggestionEl);
                    });

                } catch (error) {
                    console.error("Error al obtener sugerencias:", error);
                    showMessage("Error", "No se pudieron generar las sugerencias.");
                } finally {
                    processingOverlay.classList.add('hidden');
                }
            });
        }
        
        function populateFilters() {
            const yearSelect = document.getElementById('filter-year');
            const monthSelect = document.getElementById('filter-month');
            if(!yearSelect || !monthSelect) return;

            const years = [...new Set(allPurchases.map(p => new Date(p.fecha).getFullYear()))].sort((a,b) => b-a);
            yearSelect.innerHTML = '<option value="all">Todos los A√±os</option>';
            years.forEach(year => yearSelect.innerHTML += `<option value="${year}">${year}</option>`);
            const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            monthSelect.innerHTML = '<option value="all">Todos los Meses</option>';
            months.forEach((month, index) => monthSelect.innerHTML += `<option value="${index}">${month}</option>`);
            yearSelect.addEventListener('change', renderDashboard);
            monthSelect.addEventListener('change', renderDashboard);
        }

        function renderDashboard() {
            if(!document.getElementById('app-content').classList.contains('hidden')) {
                const selectedYear = document.getElementById('filter-year').value;
                const selectedMonth = document.getElementById('filter-month').value;
                currentFilteredPurchases = allPurchases.filter(p => {
                    const date = new Date(p.fecha);
                    const yearMatch = selectedYear === 'all' || date.getFullYear() == selectedYear;
                    const monthMatch = selectedMonth === 'all' || date.getMonth() == selectedMonth;
                    return yearMatch && monthMatch;
                });
                document.getElementById('total-expense').textContent = `${currentFilteredPurchases.reduce((s, p) => s + (p.total || 0), 0).toFixed(2).replace('.',',')} ‚Ç¨`;
                document.getElementById('total-purchases').textContent = currentFilteredPurchases.length;
                
                categoryChartLevel = 1;
                selectedPrincipal = null;
                selectedFamilia = null;

                renderSupermarketChart(currentFilteredPurchases);
                renderCategoryChart();
                renderPurchasesHistory(currentFilteredPurchases);
            }
        }

        function renderSupermarketChart(data) {
            const ctx = document.getElementById('supermarket-chart').getContext('2d');
            const spendingBySupermarket = data.reduce((acc, p) => {
                acc[p.supermercado] = (acc[p.supermercado] || 0) + (p.total || 0);
                return acc;
            }, {});
            if (supermarketChart) supermarketChart.destroy();
            supermarketChart = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(spendingBySupermarket), datasets: [{ data: Object.values(spendingBySupermarket), backgroundColor: chartColors, hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false } });
        }
        
        const categoryChartTitle = document.getElementById('category-chart-title');
        const categoryChartBackBtn = document.getElementById('category-chart-back-btn');

        function renderCategoryChart() {
            const ctx = document.getElementById('category-chart').getContext('2d');
            let spendingData = {};
            let chartLabel = '';

            const allItems = currentFilteredPurchases.flatMap(p => p.items || []);

            if (categoryChartLevel === 1) {
                categoryChartTitle.textContent = 'Gasto por Categor√≠a Principal';
                categoryChartBackBtn.classList.add('hidden');
                spendingData = allItems.reduce((acc, item) => {
                    const itemTotal = (item.cantidad || 1) * (item.precio_unitario || 0);
                    const category = item.categoria_principal || "Otros";
                    acc[category] = (acc[category] || 0) + itemTotal;
                    return acc;
                }, {});
                chartLabel = 'Gasto por Categor√≠a Principal';
            } else if (categoryChartLevel === 2) {
                categoryChartTitle.textContent = `Desglose de ${cleanLabel(selectedPrincipal)}`;
                categoryChartBackBtn.classList.remove('hidden');
                spendingData = allItems.filter(item => item.categoria_principal === selectedPrincipal).reduce((acc, item) => {
                    const itemTotal = (item.cantidad || 1) * (item.precio_unitario || 0);
                    const family = item.familia || "Otros";
                    acc[family] = (acc[family] || 0) + itemTotal;
                    return acc;
                }, {});
                chartLabel = 'Gasto por Familia';
            } else if (categoryChartLevel === 3) {
                categoryChartTitle.textContent = `Desglose de ${cleanLabel(selectedFamilia)}`;
                categoryChartBackBtn.classList.remove('hidden');
                 spendingData = allItems.filter(item => item.familia === selectedFamilia).reduce((acc, item) => {
                    const itemTotal = (item.cantidad || 1) * (item.precio_unitario || 0);
                    const subfamily = item.subfamilia || "Otros";
                    acc[subfamily] = (acc[subfamily] || 0) + itemTotal;
                    return acc;
                }, {});
                chartLabel = 'Gasto por Subfamilia';
            }

            if (categoryChart) categoryChart.destroy();
            categoryChart = new Chart(ctx, { 
                type: 'doughnut', 
                data: { 
                    labels: Object.keys(spendingData).map(cleanLabel), 
                    datasets: [{ 
                        label: chartLabel,
                        data: Object.values(spendingData), 
                        backgroundColor: chartColors, 
                        hoverOffset: 4 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const originalLabels = Object.keys(spendingData);
                            const clickedLabel = originalLabels[elements[0].index];
                            handleCategoryChartClick(clickedLabel);
                        }
                    }
                } 
            });
        }

        function handleCategoryChartClick(label) {
            if (categoryChartLevel === 1) {
                categoryChartLevel = 2;
                selectedPrincipal = label;
                renderCategoryChart();
            } else if (categoryChartLevel === 2) {
                categoryChartLevel = 3;
                selectedFamilia = label;
                renderCategoryChart();
            }
        }

        categoryChartBackBtn.addEventListener('click', () => {
            if (categoryChartLevel > 1) {
                categoryChartLevel--;
                if (categoryChartLevel === 1) {
                    selectedPrincipal = null;
                    selectedFamilia = null;
                } else if (categoryChartLevel === 2) {
                    selectedFamilia = null;
                }
                renderCategoryChart();
            }
        });

        function renderPurchasesHistory(data) {
            const tbody = document.getElementById('purchases-history');
            tbody.innerHTML = '';
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4">No hay compras para los filtros seleccionados.</td></tr>`;
                return;
            }
            data.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).forEach(p => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';
                row.innerHTML = `
                    <td class="p-4">
                        <input type="checkbox" data-id="${p.id}" class="row-checkbox w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                    </td>
                    <td class="px-6 py-4">${new Date(p.fecha).toLocaleDateString('es-ES')}</td>
                    <td class="px-6 py-4 font-medium text-gray-900">${p.supermercado}</td>
                    <td class="px-6 py-4">${(p.total || 0).toFixed(2).replace('.',',')} ‚Ç¨</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function renderProductsTab() {
            const products = {};
            allPurchases.forEach(purchase => {
                (purchase.items || []).forEach(item => {
                    const productName = item.producto.toLowerCase().trim();
                    if (!products[productName]) {
                        products[productName] = { 
                            display_name: item.producto, 
                            categoria_principal: item.categoria_principal, 
                            familia: item.familia,
                            subfamilia: item.subfamilia,
                            count: 0, 
                            prices: [] 
                        };
                    }
                    products[productName].count++;
                    products[productName].prices.push(item.precio_unitario || 0);
                });
            });
            const tableBody = document.getElementById('products-table');
            tableBody.innerHTML = '';
            if (Object.keys(products).length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4">No has comprado ning√∫n producto todav√≠a.</td></tr>`;
                return;
            }

            Object.entries(products).forEach(([productName, productData]) => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';
                const avgPrice = productData.prices.reduce((a, b) => a + b, 0) / productData.prices.length;

                const createSelect = (options, selectedValue) => {
                    const select = document.createElement('select');
                    select.className = 'bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5';
                    options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.textContent = cleanLabel(opt);
                        if (opt === selectedValue) option.selected = true;
                        select.appendChild(option);
                    });
                    return select;
                };

                const mainCatSelect = createSelect(Object.keys(categorias), productData.categoria_principal);
                const familySelect = document.createElement('select');
                familySelect.className = 'bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5';
                const subfamilySelect = document.createElement('select');
                subfamilySelect.className = 'bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5';

                const updateFamilyOptions = () => {
                    const selectedMain = mainCatSelect.value;
                    const families = selectedMain ? Object.keys(categorias[selectedMain] || {}) : [];
                    familySelect.innerHTML = '';
                    families.forEach(fam => {
                        const option = document.createElement('option');
                        option.value = fam;
                        option.textContent = cleanLabel(fam);
                        if (fam === productData.familia) option.selected = true;
                        familySelect.appendChild(option);
                    });
                    updateSubfamilyOptions();
                };

                const updateSubfamilyOptions = () => {
                    const selectedMain = mainCatSelect.value;
                    const selectedFamily = familySelect.value;
                    const subfamilies = (categorias[selectedMain] && categorias[selectedMain][selectedFamily]) ? categorias[selectedMain][selectedFamily] : [];
                    subfamilySelect.innerHTML = '';
                    subfamilies.forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub;
                        option.textContent = cleanLabel(sub);
                        if (sub === productData.subfamilia) option.selected = true;
                        subfamilySelect.appendChild(option);
                    });
                };
                
                const handleCategoryChange = () => {
                    updateProductCategory(productName, mainCatSelect.value, familySelect.value, subfamilySelect.value);
                };

                mainCatSelect.addEventListener('change', () => { updateFamilyOptions(); handleCategoryChange(); });
                familySelect.addEventListener('change', () => { updateSubfamilyOptions(); handleCategoryChange(); });
                subfamilySelect.addEventListener('change', handleCategoryChange);

                updateFamilyOptions();

                row.innerHTML = `<td class="px-6 py-4 font-medium text-gray-900">${productData.display_name}</td><td class="px-6 py-4"></td><td class="px-6 py-4"></td><td class="px-6 py-4"></td><td class="px-6 py-4 text-center">${productData.count}</td><td class="px-6 py-4">${avgPrice.toFixed(2).replace('.',',')} ‚Ç¨</td>`;
                row.cells[1].appendChild(mainCatSelect);
                row.cells[2].appendChild(familySelect);
                row.cells[3].appendChild(subfamilySelect);
                tableBody.appendChild(row);
            });
        }

        async function updateProductCategory(productNameToUpdate, newMain, newFamily, newSubfamily) {
            if (!userId) return;
            processingOverlay.querySelector('p').textContent = "Actualizando categor√≠as...";
            processingOverlay.classList.remove('hidden');
            const productNameLower = productNameToUpdate.toLowerCase().trim();
            const batch = writeBatch(db);
            allPurchases.filter(p => p.items.some(item => item.producto.toLowerCase().trim() === productNameLower)).forEach(purchase => {
                const docRef = doc(db, `users/${userId}/compras`, purchase.id);
                const newItems = purchase.items.map(item => {
                    if (item.producto.toLowerCase().trim() === productNameLower) {
                        return { ...item, categoria_principal: newMain, familia: newFamily, subfamilia: newSubfamily };
                    }
                    return item;
                });
                batch.update(docRef, { items: newItems });
            });
            try {
                await batch.commit();
                showMessage("Actualizado", `La categor√≠a de "${productNameToUpdate}" ha sido actualizada.`);
            } catch (error) {
                console.error("Error actualizando categor√≠as:", error);
                showMessage("Error", "No se pudo actualizar la categor√≠a del producto.");
            } finally {
                processingOverlay.classList.add('hidden');
            }
        }
        
        const modal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmContent = document.getElementById('confirmation-content');
        const confirmSaveBtn = document.getElementById('confirm-save-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

        function showMessage(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
        }
        function hideMessage() {
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
        modalCloseBtn.addEventListener('click', hideMessage);

        function displayPurchaseConfirmation(data) {
            let itemsHtml = '<table class="w-full text-sm"><thead><tr class="border-b"><th class="text-left p-2">Producto</th><th class="text-left p-2">Categor√≠a</th></tr></thead><tbody>';
            (data.items || []).forEach(item => {
                itemsHtml += `<tr class="border-b"><td class="p-2">${item.producto}</td><td class="p-2 text-xs">${cleanLabel(item.categoria_principal)} > ${cleanLabel(item.familia)} > ${cleanLabel(item.subfamilia)}</td></tr>`;
            });
            itemsHtml += '</tbody></table>';
            confirmContent.innerHTML = `
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div><strong>Supermercado:</strong><br>${data.supermercado}</div>
                    <div><strong>Fecha:</strong><br>${new Date(data.fecha).toLocaleDateString('es-ES')}</div>
                    <div><strong>Total:</strong><br><span class="font-bold text-lg">${(data.total || 0).toFixed(2)}‚Ç¨</span></div>
                </div>
                ${itemsHtml}
            `;
            confirmationModal.classList.remove('hidden');
            setTimeout(() => confirmationModal.classList.remove('opacity-0'), 10);
        }
        
        function hideConfirmationModal() {
            confirmationModal.classList.add('opacity-0');
            setTimeout(() => confirmationModal.classList.add('hidden'), 300);
        }

        confirmCancelBtn.addEventListener('click', hideConfirmationModal);
        confirmSaveBtn.addEventListener('click', async () => {
            if (!currentPurchaseData || !userId) return;
            hideConfirmationModal();
            processingOverlay.querySelector('p').textContent = "Guardando compra...";
            processingOverlay.classList.remove('hidden');
            
            try {
                const purchaseToSave = { ...currentPurchaseData };
                const purchasesCol = collection(db, `users/${userId}/compras`);
                await addDoc(purchasesCol, purchaseToSave);
                
                showMessage("√âxito", "La compra ha sido guardada correctamente.");
                
                fileUpload.value = '';
                imagePreviewContainer.innerHTML = '<p>Aqu√≠ ver√°s la imagen de tu ticket.</p>';
                processBtn.disabled = true;
                currentPurchaseData = null;
                fileBase64 = null;
                currentFile = null;
            } catch (error) {
                console.error("Error guardando la compra:", error);
                showMessage("Error", "No se pudo guardar la compra. Revisa las reglas de seguridad de Firestore.");
            } finally {
                processingOverlay.classList.add('hidden');
            }
        });
        
        const deleteSelectedBtn = document.getElementById('delete-selected-btn');
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const deleteModalMessage = document.getElementById('delete-modal-message');
        const deleteConfirmBtn = document.getElementById('delete-confirm-btn');
        const deleteCancelBtn = document.getElementById('delete-cancel-btn');
        let onConfirmDelete = () => {};

        function updateDeleteButtonState() {
            deleteSelectedBtn.disabled = selectedPurchases.size === 0;
        }

        document.getElementById('purchases-history').addEventListener('change', (e) => {
            if (e.target.classList.contains('row-checkbox')) {
                const id = e.target.dataset.id;
                if (e.target.checked) {
                    selectedPurchases.add(id);
                } else {
                    selectedPurchases.delete(id);
                }
                updateDeleteButtonState();
            }
        });

        selectAllCheckbox.addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = e.target.checked;
                const id = checkbox.dataset.id;
                if (e.target.checked) {
                    selectedPurchases.add(id);
                } else {
                    selectedPurchases.delete(id);
                }
            });
            updateDeleteButtonState();
        });

        deleteSelectedBtn.addEventListener('click', () => {
            if (selectedPurchases.size === 0) return;
            
            deleteModalMessage.textContent = `¬øEst√°s seguro de que quieres eliminar ${selectedPurchases.size} ticket(s)? Esta acci√≥n no se puede deshacer.`;
            deleteConfirmModal.classList.remove('hidden');
            setTimeout(() => deleteConfirmModal.classList.remove('opacity-0'), 10);

            onConfirmDelete = async () => {
                hideDeleteConfirmModal();
                processingOverlay.querySelector('p').textContent = "Eliminando tickets...";
                processingOverlay.classList.remove('hidden');
                
                const deletePromises = [];
                for (const id of selectedPurchases) {
                    const docRef = doc(db, `users/${userId}/compras`, id);
                    deletePromises.push(deleteDoc(docRef));
                }

                try {
                    await Promise.all(deletePromises);
                    showMessage("√âxito", `${selectedPurchases.size} ticket(s) han sido eliminados.`);
                } catch (error) {
                    console.error("Error eliminando tickets:", error);
                    showMessage("Error", "No se pudieron eliminar los tickets.");
                } finally {
                    selectedPurchases.clear();
                    selectAllCheckbox.checked = false;
                    updateDeleteButtonState();
                    processingOverlay.classList.add('hidden');
                }
            };
        });

        function hideDeleteConfirmModal() {
            deleteConfirmModal.classList.add('opacity-0');
            setTimeout(() => deleteConfirmModal.classList.add('hidden'), 300);
        }

        deleteConfirmBtn.addEventListener('click', () => onConfirmDelete());
        deleteCancelBtn.addEventListener('click', hideDeleteConfirmModal);

        // --- ONBOARDING Y PREMIUM MODALS ---
        const welcomeModal = document.getElementById('welcome-modal');
        const welcomeCloseBtn = document.getElementById('welcome-close-btn');
        const upgradeModal = document.getElementById('upgrade-modal');
        const upgradeCloseBtn = document.getElementById('upgrade-close-btn');
        
        function showWelcomeModal() {
            welcomeModal.classList.remove('hidden');
            setTimeout(() => welcomeModal.classList.remove('opacity-0'), 10);
        }
        function hideWelcomeModal() {
            welcomeModal.classList.add('opacity-0');
            setTimeout(() => welcomeModal.classList.add('hidden'), 300);
        }
        welcomeCloseBtn.addEventListener('click', hideWelcomeModal);
        
        function showUpgradeModal() {
            upgradeModal.classList.remove('hidden');
            setTimeout(() => upgradeModal.classList.remove('opacity-0'), 10);
        }
        function hideUpgradeModal() {
            upgradeModal.classList.add('opacity-0');
            setTimeout(() => upgradeModal.classList.add('hidden'), 300);
        }
        upgradeCloseBtn.addEventListener('click', hideUpgradeModal);
        document.querySelectorAll('.upgrade-btn, .premium-overlay').forEach(el => {
            el.addEventListener('click', showUpgradeModal);
        });

    </script>
</body>
</html>
